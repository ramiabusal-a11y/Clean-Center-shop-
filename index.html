<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متجر إلكتروني نيو-مورفيزم (مستقر)</title>
    
    <!-- تحميل مكتبة Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- تحميل مكتبة React و ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- تحميل مكتبة Chart.js للرسوم البيانية -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- تحميل مكتبة Sheet.js لتصدير Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    
    <script>
        // إعداد Tailwind CSS
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#6366f1', // Indigo
                        'secondary': '#f97316', // Orange
                        'neumo-base': '#e0e5ec', // Light Gray Base for Neumorphism
                        'neumo-dark': '#a3b1c6',
                        'neumo-light': '#ffffff',
                    },
                }
            }
        }
    </script>

    <style>
        /* خط Inter (افتراضي لـ Tailwind) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0e5ec; /* لون الخلفية الرئيسي للنيومورفيزم */
            min-height: 100vh;
        }
        
        /* Neumorphism Base Style (Raised effect) */
        .neumo-card {
            background-color: #e0e5ec;
            border-radius: 20px;
            box-shadow: 8px 8px 16px #a3b1c6, -8px -8px 16px #ffffff;
            @apply p-5 rounded-2xl;
        }
        
        /* Neumorphism Input Style (Pressed effect) */
        .neumo-input {
            background-color: #e0e5ec;
            border-radius: 10px;
            box-shadow: inset 2px 2px 5px #a3b1c6, inset -2px -2px 5px #ffffff;
            @apply w-full p-3 rounded-xl border-none text-gray-800 placeholder-gray-500 transition duration-200 focus:ring-primary focus:shadow-none;
        }
        .neumo-input:focus {
            box-shadow: inset 1px 1px 2px #a3b1c6, inset -1px -1px 2px #ffffff;
        }

        /* Neumorphism Button Style (Raised) */
        .neumo-btn {
            background-color: #e0e5ec;
            border-radius: 12px;
            box-shadow: 4px 4px 8px #a3b1c6, -4px -4px 8px #ffffff;
            @apply text-gray-700 font-bold py-3 px-6 transition-all duration-300 transform hover:shadow-none hover:scale-[0.98];
        }
        
        /* Primary Neumorphism Button (Colored) */
        .neumo-btn-primary {
            background-color: #6366f1; /* Primary color */
            box-shadow: 4px 4px 8px #484bac, -4px -4px 8px #7e80ff;
            @apply text-white hover:bg-indigo-600 hover:shadow-inner;
        }
        
        /* Secondary Neumorphism Button (Colored) */
        .neumo-btn-secondary {
            background-color: #f97316; /* Secondary color */
            box-shadow: 4px 4px 8px #b4570d, -4px -4px 8px #ff8f1f;
            @apply text-white hover:bg-orange-600 hover:shadow-inner;
        }

        /* CSS for Print (A4) */
        @media print {
            body {
                background: white; /* خلفية بيضاء للطباعة */
                color: black;
            }
            .no-print {
                display: none !important;
            }
            .print-area {
                width: 210mm; /* عرض A4 */
                height: 297mm; /* ارتفاع A4 */
                margin: 0;
                padding: 10mm;
                box-shadow: none;
            }
            /* إخفاء سلة التسوق عند الطباعة في واجهة المتسوق */
            .shop-cart {
                display: none !important;
            }
            /* إزالة تأثيرات النيومورفيزم عند الطباعة */
            .neumo-card, .neumo-input, .neumo-btn {
                box-shadow: none !important;
                background-color: white !important;
                border: 1px solid #ccc !important;
            }
            table th, table td {
                border-color: #000 !important;
                color: #000 !important;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="root">
        <!-- يتم تحميل تطبيق React هنا -->
    </div>

    <script>
        // استخدام React.createElement بدلاً من JSX
        const { createElement: e, useState, useEffect, useCallback, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;

        // ====================================================================================
        // 1. IndexedDB Utility - أداة تخزين IndexedDB (تم الاسترجاع)
        // ====================================================================================
        const DB_NAME = 'ECommerceStoreDB';
        const DB_VERSION = 1;
        const STORE_NAMES = ['categories', 'products', 'settings', 'cart'];
        
        let db;

        const openDB = () => new Promise((resolve, reject) => {
            if (db) return resolve(db);

            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onupgradeneeded = (event) => {
                const dbInstance = event.target.result;
                STORE_NAMES.forEach(storeName => {
                    if (!dbInstance.objectStoreNames.contains(storeName)) {
                        dbInstance.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                    }
                });
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };

            request.onerror = (event) => {
                console.error("IndexedDB Error:", event.target.error);
                reject(event.target.error);
            };
        });

        const idb = {
            async getAll(storeName) {
                const dbInstance = await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = dbInstance.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            async get(storeName, id) {
                const dbInstance = await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = dbInstance.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(id);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            async put(storeName, item) {
                const dbInstance = await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = dbInstance.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    // استخدام ID موجود أو توليد واحد جديد
                    const itemToStore = { ...item, id: item.id || crypto.randomUUID() };
                    const request = store.put(itemToStore);

                    request.onsuccess = () => resolve(itemToStore.id);
                    request.onerror = () => reject(request.error);
                });
            },
            async delete(storeName, id) {
                const dbInstance = await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = dbInstance.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            async clearAll() {
                const dbInstance = await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = dbInstance.transaction(STORE_NAMES, 'readwrite');
                    let cleared = 0;
                    
                    STORE_NAMES.forEach(storeName => {
                        const store = transaction.objectStore(storeName);
                        store.clear().onsuccess = () => {
                            cleared++;
                            if (cleared === STORE_NAMES.length) resolve();
                        };
                    });

                    transaction.onerror = () => reject(transaction.error);
                });
            },
            async importData(data) {
                const dbInstance = await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = dbInstance.transaction(STORE_NAMES, 'readwrite');
                    let importedCount = 0;
                    
                    STORE_NAMES.forEach(storeName => {
                        if (data[storeName] && Array.isArray(data[storeName])) {
                            const store = transaction.objectStore(storeName);
                            data[storeName].forEach(item => {
                                store.put(item); 
                            });
                            importedCount++;
                        } else {
                            importedCount++; 
                        }
                    });

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                });
            },
            async exportData() {
                const exportedData = {};
                for (const storeName of STORE_NAMES) {
                    exportedData[storeName] = await idb.getAll(storeName);
                }
                return exportedData;
            }
        };


        // ====================================================================================
        // 2. Core Components - المكونات الأساسية
        // ====================================================================================

        /**
         * مكون شريط التنبيهات والرسائل
         */
        const Alert = ({ message, type = 'info', onClose }) => {
            const baseClasses = "neumo-card p-4 rounded-xl shadow-lg flex justify-between items-center fixed top-4 left-1/2 -translate-x-1/2 z-50 min-w-[300px] max-w-full transition-all duration-300 transform";
            let colorClasses = "";
            let textClasses = "text-gray-900";

            switch (type) {
                case 'success':
                    colorClasses = "bg-green-100 border-l-4 border-green-500"; 
                    break;
                case 'error':
                    colorClasses = "bg-red-100 border-l-4 border-red-500"; 
                    break;
                case 'warning':
                    colorClasses = "bg-yellow-100 border-l-4 border-yellow-500"; 
                    break;
                case 'info':
                default:
                    colorClasses = "bg-blue-100 border-l-4 border-blue-500"; 
                    break;
            }
            
            // Adjust neumorphism style for alerts to be slightly recessed
            const neumorphismStyle = {
                boxShadow: 'inset 2px 2px 5px #a3b1c6, inset -2px -2px 5px #ffffff',
                backgroundColor: '#f0f4f8'
            };

            return e('div', { className: `${baseClasses} ${colorClasses} animate-pulse`, style: neumorphismStyle },
                e('p', { className: textClasses }, message),
                onClose && e('button', {
                    onClick: onClose,
                    className: "ml-4 text-gray-600 hover:text-gray-900 transition"
                }, '×')
            );
        };

        /**
         * مكون مؤشر التحميل
         */
        const LoadingSpinner = () => e('div', { className: "flex justify-center items-center h-[calc(100vh-64px)] w-full" },
            e('div', { className: "animate-spin rounded-full h-12 w-12 border-b-4 border-primary" })
        );

        // ====================================================================================
        // 3. Application Context and State - السياق وحالة التطبيق
        // ====================================================================================

        const AppContext = React.createContext();

        const AppProvider = ({ children }) => {
            const [page, setPage] = useState('home'); 
            const [categories, setCategories] = useState([]);
            const [products, setProducts] = useState([]);
            const [settings, setSettings] = useState({ 
                whatsappNumber: '', 
                adminPassword: '12345', 
                storeName: 'متجرنا الإلكتروني', 
                storeImage: '',
                // لإعادة التخزين المحلي
                lastBackupDate: null 
            });
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [alert, setAlert] = useState(null); 
            const [cart, setCart] = useState({}); 
            const [lastBackupDate, setLastBackupDate] = useState(null); // يستخدم فقط للعرض
            
            const showAlert = useCallback((message, type = 'info', duration = 4000) => {
                setAlert({ message, type });
                if (duration > 0) {
                    setTimeout(() => setAlert(null), duration);
                }
            }, []);

            // ** وظيفة تحميل البيانات الأولية من IndexedDB (تم الاسترجاع) **
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const [cats, prods, storedSettings] = await Promise.all([
                            idb.getAll('categories'),
                            idb.getAll('products'),
                            idb.getAll('settings'),
                        ]);
                        setCategories(cats);
                        setProducts(prods);
                        
                        if (storedSettings.length > 0) {
                            const loadedSettings = storedSettings[0];
                            const finalSettings = {
                                ...settings,
                                ...loadedSettings,
                                adminPassword: loadedSettings.adminPassword || '12345' 
                            };
                            setSettings(finalSettings);
                            setLastBackupDate(finalSettings.lastBackupDate || null);
                        } else {
                            await idb.put('settings', { id: crypto.randomUUID(), ...settings });
                        }
                        
                    } catch (error) {
                        showAlert('حدث خطأ أثناء تحميل البيانات المحلية.', 'error');
                        console.error('Initial data load error:', error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                loadData();
            }, [showAlert]); 

            // ** وظيفة حفظ الإعدادات (IndexedDB) **
            const saveSettings = useCallback(async (newSettings) => {
                try {
                    const currentSettingsList = await idb.getAll('settings');
                    const currentSettings = currentSettingsList.length > 0 ? currentSettingsList[0] : { id: crypto.randomUUID() };
                    
                    const settingsToSave = { 
                        ...currentSettings, 
                        ...settings,
                        ...newSettings 
                    };
                    
                    await idb.put('settings', settingsToSave);
                    setSettings(settingsToSave);
                    showAlert('تم حفظ الإعدادات بنجاح.', 'success', 2000);
                    return settingsToSave;
                } catch (error) {
                    showAlert('فشل في حفظ الإعدادات.', 'error');
                    console.error('Settings save error:', error);
                    return null;
                }
            }, [showAlert, settings]);

            // ** وظيفة تحديث البيانات وحفظها (CRUD - IndexedDB) **
            const updateData = useCallback(async (storeName, data, isDelete = false) => {
                setIsLoading(true);
                try {
                    if (isDelete) {
                        await idb.delete(storeName, data.id);
                        showAlert('تم الحذف بنجاح.', 'success', 2000);
                    } else {
                        const newId = await idb.put(storeName, data);
                        if (!data.id) data.id = newId; 
                        showAlert('تم الحفظ بنجاح.', 'success', 2000);
                    }
                    
                    const updatedList = await idb.getAll(storeName);
                    if (storeName === 'categories') setCategories(updatedList);
                    if (storeName === 'products') setProducts(updatedList);
                    
                } catch (error) {
                    showAlert('فشل في حفظ/حذف البيانات.', 'error');
                    console.error('Data update error:', error);
                } finally {
                    setIsLoading(false);
                }
            }, [showAlert]);
            
            // ** وظائف النسخ الاحتياطي (IndexedDB - تم الاسترجاع) **
            const exportJson = useCallback(async () => {
                try {
                    const data = await idb.exportData();
                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ecom_backup_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    const now = new Date().toISOString();
                    setLastBackupDate(now);
                    await saveSettings({ lastBackupDate: now });
                    
                    showAlert('تم تصدير البيانات بنجاح كملف JSON.', 'success');
                } catch (error) {
                    showAlert('فشل في تصدير JSON.', 'error');
                    console.error('Export JSON error:', error);
                }
            }, [showAlert, saveSettings]);

            const importJson = useCallback((e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        await idb.importData(data);
                        
                        // إعادة تحميل البيانات لـ React state
                        const [cats, prods, storedSettings] = await Promise.all([
                            idb.getAll('categories'),
                            idb.getAll('products'),
                            idb.getAll('settings'),
                        ]);
                        setCategories(cats);
                        setProducts(prods);
                        if (storedSettings.length > 0) {
                            const finalSettings = { ...settings, ...storedSettings[0] };
                            setSettings(finalSettings);
                        }
                        
                        const now = new Date().toISOString();
                        setLastBackupDate(now);
                        await saveSettings({ lastBackupDate: now });

                        showAlert('تم استيراد البيانات بنجاح. قد تحتاج لإعادة الدخول للمدير.', 'success', 5000);
                    } catch (error) {
                        showAlert('فشل في استيراد البيانات. تأكد من أن الملف بصيغة JSON صحيحة.', 'error', 7000);
                        console.error('Import JSON error:', error);
                    }
                };
                reader.readAsText(file);
            }, [showAlert, saveSettings, settings]);

            const exportExcel = useCallback(async () => {
                try {
                    const data = await idb.exportData();
                    const workbook = XLSX.utils.book_new();

                    const productData = data.products.map(p => ({
                        'اسم المنتج': p.name,
                        'السعر الأساسي': p.price,
                        'الوصف': p.description,
                        'ID القسم': p.categoryId,
                        'عدد الخيارات (Variants)': p.variants.length
                    }));
                    XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(productData), 'المنتجات');

                    const categoryData = data.categories.map(c => ({
                        'ID القسم': c.id,
                        'اسم القسم': c.name,
                    }));
                    XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(categoryData), 'الأقسام');

                    XLSX.writeFile(workbook, `ecom_report_${new Date().toISOString().slice(0, 10)}.xlsx`);
                    showAlert('تم تصدير البيانات بنجاح كملف Excel.', 'success');
                } catch (error) {
                    showAlert('فشل في تصدير Excel.', 'error');
                    console.error('Export Excel error:', error);
                }
            }, [showAlert]);
            
            // ** وظيفة مسح جميع البيانات (IndexedDB) **
            const deleteAllData = useCallback(async () => {
                if (!window.confirm('هل أنت متأكد من حذف جميع بيانات المتجر (الأقسام والمنتجات والإعدادات) بشكل نهائي؟ هذا الإجراء لا يمكن التراجع عنه!')) {
                    return;
                }
                setIsLoading(true);
                try {
                    await idb.clearAll();
                    setCategories([]);
                    setProducts([]);
                    setSettings({ whatsappNumber: '', adminPassword: '12345', storeName: 'متجرنا الإلكتروني', storeImage: '' });
                    setIsAdminAuthenticated(false);
                    setCart({});
                    setLastBackupDate(null);
                    setPage('home');
                    showAlert('تم حذف جميع البيانات بنجاح.', 'success', 5000);
                } catch (error) {
                    showAlert('فشل في حذف البيانات.', 'error');
                    console.error('Delete all data error:', error);
                } finally {
                    setIsLoading(false);
                }
            }, [showAlert, setPage]);

            // وظائف السلة
            const updateCart = useCallback((product, variant, quantity) => {
                const key = `${product.id}_${variant.id}`; 
                setCart(prevCart => {
                    const newCart = { ...prevCart };
                    
                    if (quantity <= 0) {
                        delete newCart[key];
                    } else {
                        newCart[key] = { product, variant, quantity };
                    }
                    return newCart;
                });
                showAlert('تم تحديث سلة التسوق.', 'info', 1000);
            }, [showAlert]);

            const clearCart = useCallback(() => {
                setCart({});
                showAlert('تم إفراغ سلة التسوق.', 'info', 1000);
            }, [showAlert]);


            const contextValue = {
                page, setPage, categories, products, settings,
                isLoading, showAlert, alert, setAlert,
                updateData, saveSettings,
                cart, updateCart, clearCart,
                exportJson, importJson, exportExcel, 
                deleteAllData,
                lastBackupDate,
                isAdminAuthenticated, setIsAdminAuthenticated
            };

            return e(AppContext.Provider, { value: contextValue },
                children,
                alert && e(Alert, { ...alert, onClose: () => setAlert(null) })
            );
        };


        // ====================================================================================
        // 4. Shared UI Components - مكونات واجهة المستخدم المشتركة 
        // ====================================================================================

        /**
         * مكون الزر الرئيسي
         */
        const PrimaryButton = ({ children, onClick, disabled = false, className = '', isSecondary = false, isDanger = false, isSuccess = false }) => {
            let baseClasses = 'neumo-btn neumo-btn-primary';
            if (isSecondary) {
                baseClasses = 'neumo-btn neumo-btn-secondary';
            } else if (isDanger) {
                baseClasses = 'neumo-btn bg-red-500 text-white hover:bg-red-600';
            } else if (isSuccess) {
                 baseClasses = 'neumo-btn bg-green-500 text-white hover:bg-green-600';
            }
            
            return e('button', {
                onClick,
                disabled,
                className: `${baseClasses} ${disabled ? 'opacity-50 cursor-not-allowed !shadow-none' : ''} ${className}`, 
            }, children);
        };
            
        /**
         * أيقونة (SVG) - تستخدم بدلاً من مكتبات الأيقونات الخارجية
         */
        const Icon = ({ name, className = 'w-6 h-6' }) => {
            const getPath = (iconName) => {
                switch (iconName) {
                    case 'shop': return "M16 11V7a4 4 0 0 0-8 0v4M12 18V2H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-4v16a2 2 0 0 1-2 2z";
                    case 'admin': return "M10 9a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-7 9a7 7 0 1 1 14 0H3z";
                    case 'home': return "M3 12l2-2m0 0l7-7 7 7M5 10v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7";
                    case 'plus': return "M12 4.5v15m7.5-7.5h-15";
                    case 'edit': return "M12 20h9M16.5 3.5l4 4L7.5 20.5H3v-4L16.5 3.5z";
                    case 'delete': return "M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v2m-7 3h14";
                    case 'settings': return "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z";
                    case 'dashboard': return "M3 3h7v7H3zm11 0h7v7h-7zm-11 11h7v7H3zm11 0h7v7h-7z";
                    case 'whatsapp': return "M12 2a10 10 0 0 0-7.3 16.9l-1.9 2.1 2.5-4.5A9.8 9.8 0 0 0 2 12a10 10 0 0 1 20 0 9.8 9.8 0 0 1-1.3 5.4l1.9 2.1-1.9-2.1A10 10 0 0 0 12 2zm1 14.5c-.3 0-.5-.1-.7-.3l-1.9-2.1c-.2-.2-.3-.5-.3-.8s.1-.6.3-.8l2.1-2.1c.2-.2.5-.3.8-.3s.6.1.8.3l.7.7c.2.2.3.5.3.8s-.1.6-.3.8l-1.9 2.1c.2.2.3.5.3.8s-.1.6-.3.8l.7.7c.2.2.3.5.3.8s-.1.6-.3.8l-1.9 2.1c-.2.2-.5.3-.8.3z";
                    case 'export': return "M12 18V6M9 13l3-3 3 3M21 16v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3";
                    case 'import': return "M12 6v12M9 11l3 3 3-3M21 16v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3";
                    case 'trash': return "M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v2m-7 3h14";
                    case 'file-json': return "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zM14 2v6h6";
                    case 'file-excel': return "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zM14 2v6h6M8 12h8M8 16h8";
                    case 'cart': return "M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5H21M17 17a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-6 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z";
                    case 'close': return "M6 18L18 6M6 6l12 12";
                    case 'back': return "M15 18l-6-6 6-6";
                    case 'print': return "M17 17H7V7h10M17 11V7h-4V4H7v13h10M17 11H7";
                    case 'lock': return "M12 15a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm0-10a8 8 0 1 0 0 16A8 8 0 0 0 12 5z";
                    case 'list': return "M4 6h16M4 12h16M4 18h16"; // قائمة (Menu)
                    default: return "M4 6h16M4 12h16M4 18h16"; // قائمة (Menu)
                }
            };

            return e('svg', {
                className: className,
                xmlns: "http://www.w3.org/2000/svg",
                fill: "none",
                viewBox: "0 0 24 24",
                stroke: "currentColor",
                strokeWidth: "2",
                'aria-hidden': "true",
            }, e('path', {
                strokeLinecap: "round",
                strokeLinejoin: "round",
                d: getPath(name)
            }));
        };
        
        // ====================================================================================
        // 5. Admin Panel Components - مكونات لوحة المدير
        // ====================================================================================

        /**
         * شاشة تسجيل دخول المدير
         */
        const AdminLoginScreen = () => {
            const { setPage, settings, isAdminAuthenticated, setIsAdminAuthenticated, showAlert } = React.useContext(AppContext);
            const [password, setPassword] = useState('');
            
            const handleLogin = (e) => {
                e.preventDefault();
                // مقارنة كلمة المرور المدخلة بكلمة المرور المخزنة
                if (password === settings.adminPassword) {
                    setIsAdminAuthenticated(true);
                    setPage('admin');
                    showAlert('تم تسجيل الدخول بنجاح.', 'success', 2000);
                } else {
                    showAlert('كلمة المرور غير صحيحة.', 'error', 3000);
                    setPassword('');
                }
            };

            return e('div', { className: "min-h-[calc(100vh-64px)] flex flex-col items-center justify-center p-4" },
                e('div', { className: "neumo-card text-center p-8 md:p-12 max-w-sm w-full relative" },
                    // زر الرجوع
                    e(PrimaryButton, { onClick: () => setPage('home'), className: "absolute top-4 right-4 !bg-neumo-base text-gray-700 hover:text-gray-900 flex items-center p-2 text-sm" }, 
                        e(Icon, { name: 'back', className: "w-4 h-4 ml-2" }), 'عودة'
                    ),
                    
                    e('form', { onSubmit: handleLogin },
                        e('h1', { className: "text-3xl font-extrabold text-gray-800 mb-6 mt-6" }, 'تسجيل دخول المدير'),
                        e('p', { className: "text-gray-600 mb-6" }, 'الرجاء إدخال كلمة مرور المدير للمتابعة.'),
                        
                        e('div', { className: "mb-6" },
                            e('input', {
                                type: 'password',
                                value: password,
                                onChange: (e) => setPassword(e.target.value),
                                className: "neumo-input text-center",
                                placeholder: 'كلمة المرور',
                                required: true
                            })
                        ),
                        
                        e(PrimaryButton, { type: 'submit', className: "w-full flex items-center justify-center neumo-btn-primary" }, 
                            e(Icon, { name: 'lock', className: "w-5 h-5 ml-2" }), 'دخول لوحة المدير'
                        )
                    )
                )
            );
        };

        // ... (بقية مكونات لوحة المدير تبقى كما هي، وسيتم تعديل SettingsManager)
        
        /**
         * لوحة القيادة الإحصائية (Dashboard)
         */
        const Dashboard = () => {
            const { categories, products, lastBackupDate } = React.useContext(AppContext);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            
            // حساب الإحصائيات
            const stats = useMemo(() => {
                const categoryCount = categories.length;
                const productCount = products.length;
                
                const totalVariants = products.reduce((acc, p) => acc + (p.variants ? p.variants.length : 0), 0);

                const productDistribution = categories.map(cat => {
                    const count = products.filter(p => p.categoryId === cat.id).length;
                    return { name: cat.name, count };
                });
                
                return { categoryCount, productCount, totalVariants, productDistribution };
            }, [categories, products]);
            
            // إنشاء/تحديث الرسم البياني
            useEffect(() => {
                if (chartRef.current && stats.productCount > 0) {
                    const data = stats.productDistribution.map(d => d.count);
                    const labels = stats.productDistribution.map(d => d.name);
                    
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: [
                                    '#6366f1', // Primary
                                    '#f97316', // Secondary
                                    '#10b981', // Green
                                    '#f59e0b', // Amber
                                    '#8b5cf6', // Violet
                                ],
                                hoverOffset: 16,
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        color: '#4b5563', // Dark text color for light theme
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'توزيع المنتجات حسب القسم',
                                    color: '#1f2937', // Dark title color
                                }
                            }
                        }
                    });
                } else if (chartInstance.current) {
                    chartInstance.current.destroy();
                    chartInstance.current = null;
                }
                
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                        chartInstance.current = null;
                    }
                };
            }, [stats]);


            return e('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6" },
                e(StatCard, { title: "إجمالي الأقسام", value: stats.categoryCount, icon: 'list' }),
                e(StatCard, { title: "إجمالي المنتجات", value: stats.productCount, icon: 'shop' }),
                e(StatCard, { title: "إجمالي الخيارات المتاحة", value: stats.totalVariants, icon: 'plus' }),

                e('div', { className: "md:col-span-2 neumo-card h-96" }, 
                    stats.productCount > 0 ? e('canvas', { ref: chartRef, className: "w-full h-full" }) : e('p', { className: "text-center text-gray-500 py-10" }, 'لا توجد منتجات لعرض التوزيع.'),
                ),

                e('div', { className: "neumo-card md:col-span-1" },
                    e('h3', { className: "text-xl font-bold text-gray-800 mb-4 border-b border-gray-300 pb-2" }, 'معلومات النظام'),
                    e('p', { className: "text-gray-600 mb-2" }, 'آخر تحديث للنسخ الاحتياطي:'),
                    e('p', { className: "text-sm text-gray-800 font-mono" }, 
                        lastBackupDate ? new Date(lastBackupDate).toLocaleString('ar-EG', { dateStyle: 'medium', timeStyle: 'short' }) : 'لم يتم النسخ الاحتياطي بعد'
                    ),
                    e('p', { className: "text-sm text-primary mt-4" }, 'البيانات محفوظة محليًا عبر IndexedDB.')
                )
            );
        };
        
        const StatCard = ({ title, value, icon }) => e('div', { className: "neumo-card flex items-center justify-between" },
            e('div', null,
                e('p', { className: "text-sm font-medium text-gray-600" }, title),
                e('p', { className: "text-3xl font-bold text-gray-800 mt-1" }, value)
            ),
            e(Icon, { name: icon, className: "w-10 h-10 text-primary/70" })
        );

        // ** CategoryManager **
        const CategoryManager = () => { 
            const { categories, updateData, showAlert } = React.useContext(AppContext);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentCategory, setCurrentCategory] = useState(null);
            const [name, setName] = useState('');
            const [image, setImage] = useState(null); 
            
            const openModal = (category = null) => {
                setCurrentCategory(category);
                setName(category ? category.name : '');
                setImage(category ? category.image : null);
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setCurrentCategory(null);
                setName('');
                setImage(null);
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => { setImage(event.target.result); };
                reader.onerror = () => showAlert('فشل في قراءة ملف الصورة.', 'error');
                reader.readAsDataURL(file);
            };

            const handleSave = async () => {
                if (!name.trim()) { return showAlert('الرجاء إدخال اسم القسم.', 'warning'); }
                
                const categoryToSave = {
                    id: currentCategory ? currentCategory.id : null,
                    name: name.trim(),
                    image: image,
                };

                await updateData('categories', categoryToSave);
                closeModal();
            };
            
            const CategoryTable = e('div', { className: "overflow-x-auto neumo-card mt-6" },
                e('table', { className: "min-w-full divide-y divide-gray-300" }, 
                    e('thead', { className: "bg-neumo-base" }, 
                        e('tr', null,
                            e('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider" }, 'الصورة'),
                            e('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider" }, 'الاسم'),
                            e('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider hidden sm:table-cell" }, 'عدد المنتجات'),
                            e('th', { className: "relative px-6 py-3" }, 'الإجراءات')
                        )
                    ),
                    e('tbody', { className: "divide-y divide-gray-200 text-gray-800" }, 
                        categories.map(cat => e('tr', { key: cat.id },
                            e('td', { className: "px-6 py-4 whitespace-nowrap" }, 
                                cat.image ? e('img', { src: cat.image, className: "w-12 h-12 rounded-lg object-cover neumo-card !p-0" }) : e('div', { className: "w-12 h-12 bg-gray-300 rounded-lg neumo-card" })
                            ),
                            e('td', { className: "px-6 py-4 whitespace-nowrap font-medium" }, cat.name),
                            e('td', { className: "px-6 py-4 whitespace-nowrap hidden sm:table-cell" }, '0'), 
                            e('td', { className: "px-6 py-4 whitespace-nowrap text-left text-sm font-medium" },
                                e(PrimaryButton, { onClick: () => openModal(cat), className: "p-2 ml-2", isSecondary: true }, e(Icon, { name: 'edit', className: "w-4 h-4" })),
                                e(PrimaryButton, { onClick: () => updateData('categories', { id: cat.id }, true), className: "p-2", isDanger: true }, e(Icon, { name: 'delete', className: "w-4 h-4" }))
                            )
                        ))
                    )
                )
            );

            // Modal style adjusted for Neumorphism
            const modalStyle = {
                backgroundColor: '#e0e5ec',
                boxShadow: '10px 10px 20px #a3b1c6, -10px -10px 20px #ffffff'
            };

            const CategoryModal = isModalOpen && e('div', { className: "fixed inset-0 bg-gray-900 bg-opacity-40 flex items-center justify-center z-50 p-4" },
                e('div', { className: "w-full max-w-md neumo-card", style: modalStyle },
                    e('h3', { className: "text-xl font-bold text-gray-800 mb-4" }, currentCategory ? 'تعديل القسم' : 'إضافة قسم جديد'),
                    e('div', { className: "mb-4" },
                        e('label', { className: "block text-gray-700 mb-2" }, 'اسم القسم'),
                        e('input', {
                            type: 'text',
                            value: name,
                            onChange: (e) => setName(e.target.value),
                            className: "neumo-input",
                            placeholder: 'أزياء، إلكترونيات، إلخ.'
                        })
                    ),
                    e('div', { className: "mb-4" },
                        e('label', { className: "block text-gray-700 mb-2" }, 'صورة القسم'),
                        image && e('img', { src: image, className: "w-24 h-24 object-cover rounded-lg mb-2 neumo-card !p-0" }),
                        e('input', {
                            type: 'file',
                            onChange: handleImageUpload,
                            accept: 'image/*',
                            className: "neumo-input file:text-white file:bg-primary file:border-none file:rounded-xl file:cursor-pointer"
                        })
                    ),
                    e('div', { className: "flex justify-end space-x-2 space-x-reverse mt-6" },
                        e(PrimaryButton, { onClick: closeModal, className: "!bg-gray-300 text-gray-700 neumo-btn" }, 'إلغاء'),
                        e(PrimaryButton, { onClick: handleSave, isSuccess: true }, 'حفظ')
                    )
                )
            );

            return e('div', null,
                e('div', { className: "flex justify-between items-center mb-6" },
                    e('h2', { className: "text-2xl font-bold text-gray-800" }, 'إدارة الأقسام'),
                    e(PrimaryButton, { onClick: () => openModal(), isSuccess: true }, e(Icon, { name: 'plus', className: "w-5 h-5 ml-2" }), 'إضافة قسم')
                ),
                CategoryTable,
                CategoryModal
            );
        };

        // ** ProductManager **
        const ProductManager = () => { 
            const { products, categories, updateData, showAlert } = React.useContext(AppContext);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentProduct, setCurrentProduct] = useState(null);
            
            const [productForm, setProductForm] = useState({
                id: null, name: '', price: 0, description: '', categoryId: categories[0]?.id || '',
                variants: [], images: {} 
            });

            const openModal = (product = null) => {
                setCurrentProduct(product);
                if (product) {
                    setProductForm(product);
                } else {
                    setProductForm({
                        id: null, name: '', price: 0, description: '', categoryId: categories[0]?.id || '',
                        variants: [], images: {}
                    });
                }
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setCurrentProduct(null);
            };
            
            const handleChange = (e) => {
                const { name, value, type } = e.target;
                setProductForm(prev => ({
                    ...prev,
                    [name]: type === 'number' ? parseFloat(value) || 0 : value
                }));
            };
            
            const handleImageUpload = (e) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;

                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageId = crypto.randomUUID();
                        setProductForm(prev => ({
                            ...prev,
                            images: { ...prev.images, [imageId]: event.target.result }
                        }));
                    };
                    reader.onerror = () => showAlert('فشل في قراءة ملف الصورة.', 'error');
                    reader.readAsDataURL(file);
                });
            };

            const removeImage = (imageId) => {
                setProductForm(prev => {
                    const newImages = { ...prev.images };
                    delete newImages[imageId];
                    
                    const newVariants = prev.variants.map(v => ({
                        ...v,
                        imageIds: v.imageIds.filter(id => id !== imageId)
                    }));
                    
                    return { ...prev, images: newImages, variants: newVariants };
                });
            };
            
            const addVariant = () => {
                setProductForm(prev => ({
                    ...prev,
                    variants: [...prev.variants, { 
                        id: crypto.randomUUID(), 
                        color: '', 
                        size: '', 
                        priceAdjustment: 0, 
                        imageIds: [] 
                    }]
                }));
            };

            const updateVariant = (index, field, value) => {
                setProductForm(prev => {
                    const newVariants = [...prev.variants];
                    newVariants[index] = { ...newVariants[index], [field]: value };
                    return { ...prev, variants: newVariants };
                });
            };
            
            const removeVariant = (id) => {
                 setProductForm(prev => ({
                    ...prev,
                    variants: prev.variants.filter(v => v.id !== id)
                }));
            }
            
            const toggleVariantImage = (variantIndex, imageId) => {
                setProductForm(prev => {
                    const newVariants = [...prev.variants];
                    const variant = newVariants[variantIndex];
                    const imageIds = variant.imageIds;
                    
                    if (imageIds.includes(imageId)) {
                        variant.imageIds = imageIds.filter(id => id !== imageId);
                    } else {
                        variant.imageIds = [...imageIds, imageId];
                    }
                    
                    return { ...prev, variants: newVariants };
                });
            };

            const handleSave = async () => {
                if (!productForm.name.trim() || !productForm.categoryId || productForm.price <= 0) {
                    return showAlert('الرجاء إكمال اسم المنتج والسعر واختيار القسم.', 'warning');
                }
                
                const isValidVariants = productForm.variants.every(v => v.color || v.size);
                if (!isValidVariants && productForm.variants.length > 0) {
                     return showAlert('الرجاء تعيين قيمة اللون أو الحجم لكل خيار (Variant).', 'warning');
                }
                
                await updateData('products', productForm);
                closeModal();
            };

            const ProductTable = e('div', { className: "overflow-x-auto neumo-card mt-6" },
                e('table', { className: "min-w-full divide-y divide-gray-300" }, 
                    e('thead', { className: "bg-neumo-base" }, 
                        e('tr', null,
                            e('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider" }, 'الاسم'),
                            e('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider hidden sm:table-cell" }, 'القسم'),
                            e('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider" }, 'السعر'),
                            e('th', { className: "px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider hidden md:table-cell" }, 'الخيارات'),
                            e('th', { className: "relative px-6 py-3" }, 'الإجراءات')
                        )
                    ),
                    e('tbody', { className: "divide-y divide-gray-200 text-gray-800" }, 
                        products.map(p => {
                            const category = categories.find(c => c.id === p.categoryId);
                            return e('tr', { key: p.id },
                                e('td', { className: "px-6 py-4 whitespace-nowrap font-medium" }, p.name),
                                e('td', { className: "px-6 py-4 whitespace-nowrap hidden sm:table-cell" }, category ? category.name : 'غير محدد'),
                                e('td', { className: "px-6 py-4 whitespace-nowrap" }, `${p.price.toFixed(2)} ر.س`),
                                e('td', { className: "px-6 py-4 whitespace-nowrap hidden md:table-cell" }, p.variants.length || 1),
                                e('td', { className: "px-6 py-4 whitespace-nowrap text-left text-sm font-medium" },
                                    e(PrimaryButton, { onClick: () => openModal(p), className: "p-2 ml-2", isSecondary: true }, e(Icon, { name: 'edit', className: "w-4 h-4" })),
                                    e(PrimaryButton, { onClick: () => updateData('products', { id: p.id }, true), className: "p-2", isDanger: true }, e(Icon, { name: 'delete', className: "w-4 h-4" }))
                                )
                            )
                        })
                    )
                )
            );

            // Modal style adjusted for Neumorphism
            const modalStyle = {
                backgroundColor: '#e0e5ec',
                boxShadow: '10px 10px 20px #a3b1c6, -10px -10px 20px #ffffff'
            };

            const ProductModal = isModalOpen && e('div', { className: "fixed inset-0 bg-gray-900 bg-opacity-40 flex items-center justify-center z-50 p-4" },
                e('div', { className: "w-full max-w-4xl max-h-[90vh] overflow-y-auto neumo-card", style: modalStyle },
                    e('h3', { className: "text-2xl font-bold text-gray-800 mb-4 border-b border-gray-300 pb-2" }, currentProduct ? 'تعديل المنتج' : 'إضافة منتج جديد'),
                    
                    e('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" },
                        e('div', null, e('label', { className: "block text-gray-700 mb-1" }, 'اسم المنتج'), e('input', { type: 'text', name: 'name', value: productForm.name, onChange: handleChange, className: "neumo-input" })),
                        e('div', null, e('label', { className: "block text-gray-700 mb-1" }, 'السعر الأساسي (ر.س)'), e('input', { type: 'number', name: 'price', value: productForm.price, onChange: handleChange, className: "neumo-input", min: "0", step: "0.01" })),
                        e('div', null,
                            e('label', { className: "block text-gray-700 mb-1" }, 'القسم'),
                            e('select', { name: 'categoryId', value: productForm.categoryId, onChange: handleChange, className: "neumo-input" },
                                categories.length > 0 ? categories.map(cat => e('option', { key: cat.id, value: cat.id }, cat.name)) : e('option', { value: '' }, 'لا توجد أقسام')
                            )
                        ),
                        e('div', { className: "md:col-span-2" }, e('label', { className: "block text-gray-700 mb-1" }, 'الوصف'), e('textarea', { name: 'description', value: productForm.description, onChange: handleChange, className: "neumo-input h-24" })),
                    ),
                    
                    e('h4', { className: "text-xl font-bold text-gray-800 mb-3 mt-6 border-b border-gray-300 pb-1" }, 'الصور'),
                    e('div', { className: "mb-4" },
                        e('input', { type: 'file', onChange: handleImageUpload, accept: 'image/*', multiple: true, className: "neumo-input file:text-white file:bg-primary file:border-none file:rounded-xl file:cursor-pointer" }),
                        e('div', { className: "flex flex-wrap gap-3 mt-4" },
                            Object.entries(productForm.images).map(([id, dataUrl]) => e('div', { key: id, className: "relative group" },
                                e('img', { src: dataUrl, className: "w-20 h-20 object-cover rounded-lg neumo-card !p-0" }),
                                e('button', {
                                    onClick: () => removeImage(id),
                                    className: "absolute top-0 right-0 bg-red-600 rounded-full w-5 h-5 flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 transition",
                                    title: "حذف الصورة"
                                }, e(Icon, { name: 'close', className: "w-3 h-3" }))
                            ))
                        )
                    ),
                    
                    e('h4', { className: "text-xl font-bold text-gray-800 mb-3 mt-6 border-b border-gray-300 pb-1" }, 'خيارات المنتج (Variants)'),
                    e(PrimaryButton, { onClick: addVariant, className: "mb-4 text-sm" }, 'إضافة خيار جديد'),
                    
                    productForm.variants.map((v, index) => e('div', { key: v.id, className: "neumo-card p-4 rounded-xl mb-3" },
                        e('div', { className: "grid grid-cols-1 md:grid-cols-4 gap-4" },
                            e('div', null, e('label', { className: "block text-gray-700 mb-1 text-sm" }, 'اللون'), e('input', { type: 'text', value: v.color, onChange: (e) => updateVariant(index, 'color', e.target.value), className: "neumo-input" })),
                            e('div', null, e('label', { className: "block text-gray-700 mb-1 text-sm" }, 'الحجم/المقاس'), e('input', { type: 'text', value: v.size, onChange: (e) => updateVariant(index, 'size', e.target.value), className: "neumo-input" })),
                            e('div', null, e('label', { className: "block text-gray-700 mb-1 text-sm" }, 'تعديل السعر (±)'), e('input', { type: 'number', value: v.priceAdjustment, onChange: (e) => updateVariant(index, 'priceAdjustment', parseFloat(e.target.value) || 0), className: "neumo-input", step: "0.01" })),
                            e('div', { className: "flex items-end justify-end" }, e(PrimaryButton, { onClick: () => removeVariant(v.id), className: "p-2", isDanger: true }, e(Icon, { name: 'trash', className: "w-5 h-5" })))
                        ),
                        e('div', { className: "mt-4 border-t border-gray-300 pt-3" },
                            e('p', { className: "text-gray-700 text-sm mb-2" }, 'ربط صور الخيار:'),
                            e('div', { className: "flex flex-wrap gap-2" },
                                Object.entries(productForm.images).map(([id, dataUrl]) => e('button', {
                                    key: id,
                                    onClick: () => toggleVariantImage(index, id),
                                    className: `w-12 h-12 object-cover rounded-md border-2 p-0.5 transition ${v.imageIds.includes(id) ? 'border-primary' : 'border-transparent hover:border-gray-400'}`
                                }, e('img', { src: dataUrl, className: "w-full h-full object-cover rounded-md" }))
                                )
                            )
                        )
                    )),
                    
                    e('div', { className: "flex justify-end space-x-2 space-x-reverse mt-8 pt-4 border-t border-gray-300" },
                        e(PrimaryButton, { onClick: closeModal, className: "!bg-gray-300 text-gray-700 neumo-btn" }, 'إلغاء'),
                        e(PrimaryButton, { onClick: handleSave, isSuccess: true }, 'حفظ المنتج')
                    )
                )
            );
            
            return e('div', null,
                e('div', { className: "flex justify-between items-center mb-6" },
                    e('h2', { className: "text-2xl font-bold text-gray-800" }, 'إدارة المنتجات'),
                    e(PrimaryButton, { onClick: () => openModal(), disabled: categories.length === 0, isSuccess: true }, e(Icon, { name: 'plus', className: "w-5 h-5 ml-2" }), 'إضافة منتج')
                ),
                categories.length === 0 && e('p', { className: "text-red-500 mb-4 neumo-card" }, 'الرجاء إضافة قسم واحد على الأقل قبل إضافة المنتجات.'),
                ProductTable,
                ProductModal
            );
        };


        /**
         * إعدادات المتجر والأمان (محدث)
         */
        const SettingsManager = () => {
            // تم استرجاع وظائف IndexedDB
            const { settings, saveSettings, exportJson, importJson, exportExcel, deleteAllData, lastBackupDate, showAlert, setIsAdminAuthenticated } = React.useContext(AppContext);
            
            // حالة إعدادات واتساب والهوية البصرية
            const [whatsapp, setWhatsapp] = useState(settings.whatsappNumber || '');
            const [storeName, setStoreName] = useState(settings.storeName || '');
            const [storeImage, setStoreImage] = useState(settings.storeImage || '');
            
            // حالة كلمة المرور
            const [currentPassword, setCurrentPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmNewPassword, setConfirmNewPassword] = useState('');
            
            const fileInputRef = useRef(null);

            // حفظ إعدادات واتساب والهوية البصرية
            const handleSaveBranding = () => {
                saveSettings({ 
                    whatsappNumber: whatsapp.trim(),
                    storeName: storeName.trim(),
                    storeImage: storeImage
                });
            };
            
            // معالجة رفع صورة المتجر (تحويل إلى Base64)
            const handleStoreImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => { setStoreImage(event.target.result); };
                reader.onerror = () => showAlert('فشل في قراءة ملف الصورة.', 'error');
                reader.readAsDataURL(file);
            };

            // تغيير كلمة المرور
            const handleChangePassword = async () => {
                if (currentPassword !== settings.adminPassword) {
                    return showAlert('كلمة المرور الحالية غير صحيحة.', 'error');
                }
                if (!newPassword || newPassword.length < 5) {
                    return showAlert('يجب أن تكون كلمة المرور الجديدة 5 أحرف على الأقل.', 'warning');
                }
                if (newPassword !== confirmNewPassword) {
                    return showAlert('كلمة المرور الجديدة وتأكيدها غير متطابقتين.', 'error');
                }
                
                const result = await saveSettings({ adminPassword: newPassword });
                if (result) {
                    setCurrentPassword('');
                    setNewPassword('');
                    setConfirmNewPassword('');
                    setIsAdminAuthenticated(false); // إعادة طلب تسجيل الدخول بالكلمة الجديدة
                    showAlert('تم تغيير كلمة المرور بنجاح. يرجى تسجيل الدخول مجدداً.', 'success', 5000);
                }
            };


            return e('div', null,
                e('h2', { className: "text-2xl font-bold text-gray-800 mb-6 border-b border-gray-300 pb-2" }, 'إعدادات المتجر والأمان'),
                
                // إعداد الهوية البصرية (جديد)
                e('div', { className: "neumo-card mb-6" },
                    e('h3', { className: "text-xl font-bold text-gray-800 mb-4" }, 'الهوية البصرية للمتجر'),
                    e('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                        e('div', null,
                            e('label', { className: "block text-gray-700 mb-2" }, 'اسم المتجر'),
                            e('input', { 
                                type: 'text', 
                                value: storeName, 
                                onChange: (e) => setStoreName(e.target.value), 
                                className: "neumo-input", 
                                placeholder: 'اسم المتجر'
                            })
                        ),
                        e('div', null,
                            e('label', { className: "block text-gray-700 mb-2" }, 'صورة المتجر (شعار)'),
                            storeImage && e('img', { src: storeImage, className: "w-20 h-20 object-cover rounded-lg mb-2 neumo-card !p-0" }),
                            e('input', {
                                type: 'file',
                                onChange: handleStoreImageUpload,
                                accept: 'image/*',
                                className: "neumo-input file:text-white file:bg-primary file:border-none file:rounded-xl file:cursor-pointer"
                            })
                        )
                    ),
                    e(PrimaryButton, { onClick: handleSaveBranding, className: "mt-4 w-full md:w-auto", isSuccess: true }, 'حفظ الهوية البصرية')
                ),
                
                // إعداد واتساب
                e('div', { className: "neumo-card mb-6" },
                    e('h3', { className: "text-xl font-bold text-gray-800 mb-4" }, 'إعداد واتساب'),
                    e('label', { className: "block text-gray-700 mb-2" }, 'رقم واتساب (مع رمز الدولة، مثال: 966500000000)'),
                    e('div', { className: "flex space-x-2 space-x-reverse" },
                        e('input', { 
                            type: 'tel', 
                            value: whatsapp, 
                            onChange: (e) => setWhatsapp(e.target.value), 
                            className: "neumo-input flex-grow", 
                            placeholder: 'أدخل رقم الهاتف',
                            dir: "ltr"
                        }),
                        e(PrimaryButton, { onClick: handleSaveBranding, isSuccess: true }, 'حفظ')
                    ),
                    whatsapp && e('p', { className: "text-green-600 text-sm mt-2" }, `رابط واتساب جاهز: https://wa.me/${whatsapp}`)
                ),

                // تغيير كلمة المرور (جديد)
                e('div', { className: "neumo-card mb-6" },
                    e('h3', { className: "text-xl font-bold text-gray-800 mb-4" }, 'تغيير كلمة مرور المدير'),
                    e('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-4" },
                        e('div', null, e('label', { className: "block text-gray-700 mb-1" }, 'كلمة المرور الحالية'), e('input', { type: 'password', value: currentPassword, onChange: (e) => setCurrentPassword(e.target.value), className: "neumo-input", placeholder: 'الحالية' })),
                        e('div', null, e('label', { className: "block text-gray-700 mb-1" }, 'كلمة المرور الجديدة'), e('input', { type: 'password', value: newPassword, onChange: (e) => setNewPassword(e.target.value), className: "neumo-input", placeholder: 'الجديدة' })),
                        e('div', null, e('label', { className: "block text-gray-700 mb-1" }, 'تأكيد كلمة المرور'), e('input', { type: 'password', value: confirmNewPassword, onChange: (e) => setConfirmNewPassword(e.target.value), className: "neumo-input", placeholder: 'تأكيد الجديدة' })),
                    ),
                    e(PrimaryButton, { onClick: handleChangePassword, className: "mt-4 w-full md:w-auto neumo-btn-primary" }, 'تغيير وحفظ كلمة المرور')
                ),

                // النسخ الاحتياطي والأمان
                e('div', { className: "neumo-card" },
                    e('h3', { className: "text-xl font-bold text-gray-800 mb-4" }, 'النسخ الاحتياطي والأمان (البيانات المحلية)'),
                    e('p', { className: "text-sm text-gray-600 mb-4" }, 
                        `آخر تاريخ نسخ احتياطي: ${lastBackupDate ? new Date(lastBackupDate).toLocaleString('ar-EG', { dateStyle: 'medium', timeStyle: 'short' }) : 'لم يتم النسخ الاحتياطي بعد'}`
                    ),
                    e('div', { className: "grid grid-cols-2 md:grid-cols-4 gap-4" },
                        e(PrimaryButton, { onClick: exportJson, className: "text-sm flex items-center justify-center neumo-btn-primary" }, e(Icon, { name: 'file-json', className: "w-5 h-5 ml-2" }), 'تصدير JSON'),
                        e(PrimaryButton, { onClick: () => fileInputRef.current.click(), className: "text-sm flex items-center justify-center neumo-btn-primary" }, e(Icon, { name: 'import', className: "w-5 h-5 ml-2" }), 'استيراد JSON'),
                        e('input', { type: 'file', ref: fileInputRef, onChange: importJson, accept: '.json', className: "hidden" }),
                        e(PrimaryButton, { onClick: exportExcel, className: "text-sm flex items-center justify-center bg-green-500 text-white hover:bg-green-600" }, e(Icon, { name: 'file-excel', className: "w-5 h-5 ml-2" }), 'تصدير Excel'),
                        e(PrimaryButton, { onClick: deleteAllData, className: "text-sm flex items-center justify-center", isDanger: true }, e(Icon, { name: 'trash', className: "w-5 h-5 ml-2" }), 'حذف جميع البيانات')
                    ),
                    e('p', { className: "text-yellow-600 text-xs mt-6 border-t border-gray-300 pt-4" }, 
                        'ملاحظة: البيانات محفوظة محلياً في متصفحك عبر IndexedDB.'
                    )
                )
            );
        };

        /**
         * لوحة تحكم مدير المتجر (Admin Panel)
         */
        const AdminPanel = () => {
            const { setPage, isAdminAuthenticated, setIsAdminAuthenticated } = React.useContext(AppContext);

            // التحقق من المصادقة (لزيادة الأمان في حالة تغيير الـ URL مباشرة)
            useEffect(() => {
                if (!isAdminAuthenticated) {
                    setPage('adminLogin');
                }
            }, [isAdminAuthenticated, setPage]);

            if (!isAdminAuthenticated) {
                return e(LoadingSpinner); // يفضل العودة لشاشة الدخول ولكن سنعرض مؤشر تحميل مؤقتًا
            }

            const [activeTab, setActiveTab] = useState('dashboard');
            
            const renderContent = () => {
                switch (activeTab) {
                    case 'categories': return e(CategoryManager);
                    case 'products': return e(ProductManager);
                    case 'settings': return e(SettingsManager);
                    case 'dashboard':
                    default: return e(Dashboard);
                }
            };
            
            const tabs = [
                { id: 'dashboard', name: 'لوحة القيادة', icon: 'dashboard' },
                { id: 'categories', name: 'الأقسام', icon: 'list' },
                { id: 'products', name: 'المنتجات', icon: 'shop' },
                { id: 'settings', name: 'الإعدادات والأمان', icon: 'settings' },
            ];
            
            return e('div', { className: "max-w-7xl mx-auto" },
                e('div', { className: "flex justify-between items-center mb-6" },
                    e(PrimaryButton, { onClick: () => { setIsAdminAuthenticated(false); setPage('home'); }, isDanger: true, className: "flex items-center" }, 
                        'تسجيل خروج'
                    ),
                    e('h1', { className: "text-3xl font-extrabold text-gray-800" }, 'لوحة مدير المتجر')
                ),

                e('div', { className: "flex flex-wrap border-b border-gray-300 mb-8 neumo-card rounded-2xl p-2 justify-center" },
                    tabs.map(tab => e('button', {
                        key: tab.id,
                        onClick: () => setActiveTab(tab.id),
                        className: `py-2 px-4 md:px-6 rounded-xl transition-all text-sm md:text-base font-medium flex items-center m-1 ${activeTab === tab.id ? 'bg-primary text-white shadow-lg' : 'text-gray-700 hover:bg-neumo-base neumo-btn'}`
                    }, e(Icon, { name: tab.icon, className: "w-5 h-5 ml-2" }), tab.name))
                ),
                renderContent()
            );
        };


        // ====================================================================================
        // 6. Shop Components - مكونات واجهة المتسوق
        // ====================================================================================

        /**
         * سلة التسوق التفاعلية (Fixed Bottom)
         */
        const ShopCart = () => {
            const { cart, updateCart, clearCart, settings, showAlert } = React.useContext(AppContext);
            
            const cartItems = useMemo(() => Object.values(cart), [cart]);
            const total = useMemo(() => 
                cartItems.reduce((sum, item) => sum + item.quantity * (item.product.price + item.variant.priceAdjustment), 0)
            , [cartItems]);

            const createWhatsappMessage = () => {
                if (!settings.whatsappNumber) return '#';
                
                let message = 'مرحباً، أود طلب المنتجات التالية:\n\n';
                cartItems.forEach(item => {
                    const variantName = (item.variant.color || item.variant.size) ? ` (${item.variant.color} ${item.variant.size})` : '';
                    const itemPrice = item.product.price + item.variant.priceAdjustment;
                    message += `* ${item.product.name}${variantName}\n`;
                    message += `   الكمية: ${item.quantity} | السعر: ${itemPrice.toFixed(2)} ر.س\n`;
                });
                message += `\nالإجمالي: ${total.toFixed(2)} ر.س`;
                
                return `https://wa.me/${settings.whatsappNumber}?text=${encodeURIComponent(message)}`;
            };

            const whatsappLink = createWhatsappMessage();

            return e('div', { className: "shop-cart fixed bottom-0 right-0 left-0 neumo-card p-4 shadow-2xl z-40 border-t border-gray-300" },
                e('div', { className: "max-w-7xl mx-auto flex flex-wrap justify-between items-center text-gray-800" },
                    e('div', { className: "flex flex-col mb-2 sm:mb-0" },
                        e('p', { className: "text-lg font-bold" }, `الإجمالي: ${total.toFixed(2)} ر.س`),
                        e('p', { className: "text-sm text-gray-600" }, `${cartItems.length} صنف في السلة`)
                    ),
                    
                    e('div', { className: "flex space-x-2 space-x-reverse" },
                        e(PrimaryButton, { 
                            onClick: () => showAlert(
                                cartItems.length > 0 ? cartItems.map(i => `${i.product.name} - ${i.variant.color || i.variant.size} (×${i.quantity})`).join('\n') : 'السلة فارغة.',
                                'info', 10000
                            ),
                            className: "neumo-btn neumo-btn-secondary flex items-center text-sm px-3 py-2" // Secondary Button
                        }, e(Icon, { name: 'cart', className: "w-4 h-4 ml-1" }), 'تفاصيل السلة'),
                        
                        e(PrimaryButton, { onClick: clearCart, className: "neumo-btn !bg-red-500 text-white hover:!bg-red-600 flex items-center text-sm px-3 py-2", disabled: cartItems.length === 0, isDanger: true }, 'إفراغ'), // Danger Button

                        e('a', { 
                            href: whatsappLink, 
                            target: "_blank",
                            rel: "noopener noreferrer",
                            onClick: (e) => { 
                                if (cartItems.length === 0) { 
                                    e.preventDefault(); 
                                    showAlert('سلة التسوق فارغة.', 'warning');
                                } else if (whatsappLink === '#') { 
                                    e.preventDefault(); 
                                    showAlert('لم يتم إعداد رقم واتساب في لوحة المدير.', 'error');
                                }
                            },
                            className: `neumo-btn bg-green-500 text-white hover:bg-green-600 flex items-center text-sm px-4 py-2 ${cartItems.length === 0 || whatsappLink === '#' ? 'opacity-50 cursor-not-allowed !shadow-none' : ''}` // Success Button
                        }, e(Icon, { name: 'whatsapp', className: "w-5 h-5 ml-2" }), 'إرسال الطلب عبر واتساب')
                    )
                )
            );
        };

        /**
         * مكون عرض المنتجات بالتفصيل (تم التعديل لدعم إضافة أكثر من خيار)
         */
        const ProductDetail = ({ product, onBack, categories }) => {
            const { updateCart, showAlert } = React.useContext(AppContext);
            
            // تحديد الخيار الافتراضي (إذا كان هناك خيارات، اختر الأول، وإلا استخدم خيار وهمي)
            const defaultVariant = product.variants && product.variants.length > 0 ? product.variants[0] : { id: 'default', priceAdjustment: 0, imageIds: [] };
            
            // حالات لتتبع الخيار والكمية المحددة حاليًا للإضافة
            const [selectedVariant, setSelectedVariant] = useState(defaultVariant);
            const [quantity, setQuantity] = useState(1);
            
            const basePrice = product.price;
            const finalPrice = basePrice + (selectedVariant ? selectedVariant.priceAdjustment : 0);
            const category = categories.find(c => c.id === product.categoryId);
            
            const mainImage = useMemo(() => {
                const imageIds = selectedVariant.imageIds && selectedVariant.imageIds.length > 0
                    ? selectedVariant.imageIds
                    : Object.keys(product.images);
                const firstImageId = imageIds[0];
                return product.images[firstImageId] || 'https://placehold.co/600x400/d1d5db/4b5563?text=No+Image';
            }, [product.images, selectedVariant]);
            
            const handleAddToCart = () => {
                if (quantity <= 0) {
                    return showAlert('الرجاء تحديد كمية صالحة.', 'warning');
                }
                // التحقق من وجود خيار إذا كان المنتج يحتوي على خيارات
                if (product.variants && product.variants.length > 0 && !selectedVariant) {
                    return showAlert('الرجاء اختيار خيار المنتج أولاً.', 'warning');
                }

                // التأكد من أن هناك خياراً للاعتماد عليه
                const variantToUse = selectedVariant || { id: 'default', priceAdjustment: 0 };
                
                // يتم الآن إرسال المنتج بالخيار المحدد والكمية إلى السلة
                updateCart(product, variantToUse, quantity);
                setQuantity(1); // إعادة تعيين الكمية بعد الإضافة
            };

            return e('div', { className: "max-w-4xl mx-auto pb-24" }, 
                e(PrimaryButton, { onClick: onBack, className: "neumo-btn !bg-neumo-base text-gray-700 hover:text-gray-900 flex items-center mb-6" }, 
                    e(Icon, { name: 'back', className: "w-5 h-5 ml-2" }), 'العودة للمنتجات'
                ),

                e('div', { className: "neumo-card grid grid-cols-1 lg:grid-cols-2 gap-8" },
                    e('div', { className: "rounded-xl overflow-hidden neumo-card shadow-lg p-2" },
                        e('img', { 
                            src: mainImage, 
                            alt: product.name, 
                            className: "w-full h-80 object-cover rounded-lg" 
                        }),
                        e('div', { className: "flex flex-wrap gap-2 mt-4" },
                            // عرض جميع الصور في الأسفل
                            Object.entries(product.images).map(([id, url]) => {
                                // تحديد ما إذا كانت الصورة مرتبطة بالخيار المحدد حالياً
                                const isAssociatedWithSelectedVariant = selectedVariant.imageIds.includes(id);
                                return e('img', { 
                                    key: id,
                                    src: url,
                                    className: `w-16 h-16 object-cover rounded-md border-2 cursor-pointer transition ${isAssociatedWithSelectedVariant ? 'border-primary' : 'border-transparent hover:border-gray-400'}`
                                });
                            })
                        )
                    ),
                    
                    e('div', null,
                        e('h1', { className: "text-3xl font-bold text-gray-800 mb-2" }, product.name),
                        e('p', { className: "text-sm text-primary mb-4" }, category ? category.name : 'غير محدد'),
                        
                        e('div', { className: "text-4xl font-extrabold text-secondary mb-6 border-b border-gray-300 pb-4" }, 
                            `${finalPrice.toFixed(2)} ر.س`
                        ),
                        
                        e('p', { className: "text-gray-700 mb-6" }, product.description),
                        
                        // اختيار الخيارات (Variants) - مطلوب فقط إذا كان هناك خيارات
                        product.variants && product.variants.length > 0 && e('div', { className: "mb-6" },
                            e('label', { className: "block text-gray-700 mb-2 font-medium" }, 'الخيارات المتاحة:'),
                            e('div', { className: "flex flex-wrap gap-2" },
                                product.variants.map(v => e('button', {
                                    key: v.id,
                                    onClick: () => {
                                        setSelectedVariant(v);
                                        setQuantity(1); // إعادة تعيين الكمية عند تغيير الخيار
                                    },
                                    className: `py-2 px-4 rounded-full text-sm transition neumo-btn ${selectedVariant.id === v.id ? 'bg-primary text-white shadow-inner' : 'bg-neumo-base text-gray-700'}`
                                }, `${v.color || ''} ${v.size || ''} (${v.priceAdjustment >= 0 ? '+' : ''}${v.priceAdjustment.toFixed(2)} ر.س)`))
                            )
                        ),
                        
                        e('div', { className: "flex items-center space-x-4 space-x-reverse mt-8" },
                            e('div', { className: "flex items-center neumo-card rounded-xl p-1 !shadow-inner !py-0" },
                                e('button', { 
                                    onClick: () => setQuantity(q => Math.max(1, q - 1)), 
                                    className: "w-8 h-8 flex items-center justify-center text-xl text-gray-700 hover:text-gray-900 rounded-lg neumo-btn !shadow-none" 
                                }, '−'),
                                e('input', { 
                                    type: 'number', 
                                    value: quantity, 
                                    onChange: (e) => setQuantity(parseInt(e.target.value) || 1), 
                                    className: "w-12 text-center neumo-input !bg-neumo-base border-none focus:ring-0 !shadow-none",
                                    min: "1"
                                }),
                                e('button', { 
                                    onClick: () => setQuantity(q => q + 1), 
                                    className: "w-8 h-8 flex items-center justify-center text-xl text-gray-700 hover:text-gray-900 rounded-lg neumo-btn !shadow-none" 
                                }, '+')
                            ),
                            
                            e(PrimaryButton, { onClick: handleAddToCart, className: "flex-grow flex justify-center items-center text-lg neumo-btn-primary" }, 
                                e(Icon, { name: 'cart', className: "w-5 h-5 ml-2" }), 'إضافة للسلة'
                            )
                        )
                    )
                )
            );
        };


        /**
         * واجهة المتسوق
         */
        const ShopView = () => {
            const { products, categories, setPage, settings } = React.useContext(AppContext);
            // 1. Hooks MUST be called unconditionally at the top level
            const [selectedCategoryId, setSelectedCategoryId] = useState(null); 
            const [selectedProduct, setSelectedProduct] = useState(null); 
            
            const filteredProducts = useMemo(() => {
                if (!selectedCategoryId) return [];
                return products.filter(p => p.categoryId === selectedCategoryId);
            }, [products, selectedCategoryId]);

            // 2. Conditional Return is moved here, after all Hooks
            if (selectedProduct) {
                return e(ProductDetail, { 
                    product: selectedProduct, 
                    onBack: () => setSelectedProduct(null),
                    categories: categories
                });
            }

            const renderContent = () => {
                if (categories.length === 0) {
                     return e('p', { className: "text-center text-gray-500 py-16 text-xl neumo-card" }, 'لا توجد أقسام متاحة في المتجر حاليًا.');
                }
                
                if (!selectedCategoryId) {
                    return e('div', { className: "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 pb-24" },
                        categories.map(cat => e('button', {
                            key: cat.id,
                            onClick: () => setSelectedCategoryId(cat.id),
                            className: "neumo-card p-4 flex flex-col items-center justify-center text-gray-800 hover:bg-neumo-base transition rounded-xl transform hover:scale-[1.02] active:scale-[0.98]"
                        },
                            cat.image ? e('img', { src: cat.image, alt: cat.name, className: "w-20 h-20 object-cover rounded-full mb-3 neumo-card !p-0" }) : e(Icon, { name: 'list', className: "w-12 h-12 text-primary mb-3" }),
                            e('p', { className: "font-bold text-lg" }, cat.name)
                        ))
                    );
                } else {
                    const selectedCat = categories.find(c => c.id === selectedCategoryId);
                    return e('div', null,
                        e('div', { className: "flex items-center mb-6" },
                            e(PrimaryButton, { onClick: () => setSelectedCategoryId(null), className: "neumo-btn !bg-neumo-base text-gray-700 hover:text-gray-900 flex items-center text-sm" }, 
                                e(Icon, { name: 'back', className: "w-4 h-4 ml-2" }), 'العودة للأقسام'
                            ),
                            e('h2', { className: "text-2xl font-bold text-gray-800 mr-4" }, selectedCat ? selectedCat.name : 'المنتجات')
                        ),
                        
                        filteredProducts.length === 0 
                            ? e('p', { className: "text-center text-gray-500 py-10 neumo-card" }, 'لا توجد منتجات في هذا القسم.')
                            : e('div', { className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 pb-24" },
                                filteredProducts.map(p => e('div', { 
                                    key: p.id,
                                    onClick: () => setSelectedProduct(p),
                                    className: "neumo-card p-4 flex flex-col cursor-pointer hover:bg-neumo-base transition rounded-xl transform hover:scale-[1.02] active:scale-[0.98]"
                                },
                                    e('img', { 
                                        src: Object.values(p.images)[0] || 'https://placehold.co/400x300/d1d5db/4b5563?text=Product', 
                                        alt: p.name, 
                                        className: "w-full h-48 object-cover rounded-lg mb-4 neumo-card !p-0"
                                    }),
                                    e('h3', { className: "text-xl font-bold text-gray-800 truncate" }, p.name),
                                    e('p', { className: "text-secondary font-extrabold text-2xl mt-2" }, `${p.price.toFixed(2)} ر.س`),
                                    e('p', { className: "text-gray-700 text-sm mt-1 mb-4 line-clamp-2" }, p.description),
                                    e(PrimaryButton, { onClick: (e) => { e.stopPropagation(); setSelectedProduct(p); }, className: "mt-auto neumo-btn-secondary" }, 'عرض التفاصيل')
                                ))
                            )
                    );
                }
            };
            
            return e('div', { className: "max-w-7xl mx-auto" },
                e('div', { className: "flex justify-between items-center mb-8" },
                    e('h1', { className: "text-3xl font-extrabold text-gray-800" }, settings.storeName || 'المتسوق'),
                    e(PrimaryButton, { onClick: () => setPage('home'), className: "neumo-btn !bg-neumo-base text-gray-700 hover:text-gray-900 flex items-center" }, 
                        e(Icon, { name: 'home', className: "w-5 h-5 ml-2" }), 'الرئيسية'
                    )
                ),
                renderContent(),
                e(ShopCart) 
            );
        };

        // ====================================================================================
        // 7. Main Application Flow - تدفق التطبيق الرئيسي (محدث)
        // ====================================================================================

        /**
         * الشاشة الرئيسية (محدثة)
         */
        const HomeScreen = () => {
            const { setPage, settings } = React.useContext(AppContext);
            
            const defaultImage = 'https://placehold.co/200x200/6366f1/ffffff?text=Store';

            return e('div', { className: "min-h-[calc(100vh-64px)] flex flex-col items-center justify-center p-4" },
                e('div', { className: "neumo-card text-center p-8 md:p-12 max-w-lg w-full" },
                    
                    // صورة المتجر
                    e('img', {
                        src: settings.storeImage || defaultImage,
                        alt: settings.storeName || 'صورة المتجر',
                        className: "w-40 h-40 object-cover rounded-full mx-auto mb-6 ring-4 ring-primary ring-opacity-50 shadow-xl neumo-card !p-0"
                    }),

                    // اسم المتجر
                    e('h1', { className: "text-4xl md:text-5xl font-extrabold text-gray-800 mb-8" }, settings.storeName || 'متجرنا الإلكتروني'),
                    
                    e('div', { className: "flex flex-col space-y-4" },
                        e(PrimaryButton, { onClick: () => setPage('adminLogin'), className: "text-xl flex items-center justify-center neumo-btn-primary" }, 
                            e(Icon, { name: 'admin', className: "w-7 h-7 ml-3" }), 'مدير المتجر'
                        ),
                        e(PrimaryButton, { onClick: () => setPage('shop'), className: "text-xl flex items-center justify-center neumo-btn-secondary", isSecondary: true }, 
                            e(Icon, { name: 'shop', className: "w-7 h-7 ml-3" }), 'المتسوق'
                        )
                    )
                )
            );
        };


        /**
         * المكون الرئيسي (App)
         */
        const App = () => {
            const { page, isLoading, isAdminAuthenticated } = React.useContext(AppContext);

            if (isLoading) {
                return e(LoadingSpinner);
            }

            switch (page) {
                case 'adminLogin':
                    return e(AdminLoginScreen);
                case 'admin':
                    return isAdminAuthenticated ? e(AdminPanel) : e(AdminLoginScreen);
                case 'shop':
                    return e(ShopView);
                case 'home':
                default:
                    return e(HomeScreen);
            }
        };

        // ====================================================================================
        // 8. Initialization - تهيئة التطبيق
        // ====================================================================================
        
        // نقطة إدخال React
        const rootElement = document.getElementById('root');
        const root = createRoot(rootElement);
        
        root.render(e(AppProvider, null, e(App)));
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAQE_hCUNxo9_hFhSLa0yPY-dN8fZfEoos",
    authDomain: "cleane-center-shop.firebaseapp.com",
    projectId: "cleane-center-shop",
    storageBucket: "cleane-center-shop.firebasestorage.app",
    messagingSenderId: "687911431635",
    appId: "1:687911431635:web:d6580e3dc25f6b3cf49326",
    measurementId: "G-TXDX6L3RV5"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
    </script>
</body>
</html>
