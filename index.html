<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Center - مركز النظافة</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM & Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Libraries CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* A4 Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            @page {
                size: A4;
                margin: 20mm;
            }
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>

    <script>
        // Tailwind Custom Configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji'],
                    },
                    boxShadow: {
                        'glass': '0 4px 30px rgba(0, 0, 0, 0.1)',
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-800 text-gray-100 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel">
    const { useState, useEffect, useCallback, useReducer, createContext, useContext, useRef } = React;

    // --- UTILITY & HELPER FUNCTIONS ---

    const DB_NAME = 'CleanCenterDB';
    const DB_VERSION = 1;

    const openDB = () => new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject("Error opening IndexedDB.");
        request.onsuccess = () => resolve(request.result);
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('products')) {
                db.createObjectStore('products', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('categories')) {
                db.createObjectStore('categories', { keyPath: 'id' });
            }
        };
    });

    const dbAction = (storeName, mode, action) => new Promise(async (resolve, reject) => {
        const db = await openDB();
        const transaction = db.transaction(storeName, mode);
        const store = transaction.objectStore(storeName);
        const request = action(store);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = (event) => resolve(event.target.result);
    });

    const db = {
        get: (storeName, key) => dbAction(storeName, 'readonly', store => store.get(key)),
        getAll: (storeName) => dbAction(storeName, 'readonly', store => store.getAll()),
        put: (storeName, data) => dbAction(storeName, 'readwrite', store => store.put(data)),
        putAll: async (storeName, dataArray) => {
            const db = await openDB();
            const transaction = db.transaction(storeName, 'readwrite');
            const store = transaction.objectStore(storeName);
            for (const item of dataArray) {
                store.put(item);
            }
            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        },
        delete: (storeName, key) => dbAction(storeName, 'readwrite', store => store.delete(key)),
        clear: (storeName) => dbAction(storeName, 'readwrite', store => store.clear()),
    };

    const isIncognito = async () => {
        try {
            const fs = window.navigator.storage;
            if (!fs) return true; // Assume incognito if API is not available
            const quota = await fs.estimate();
            return quota.quota < 120000000;
        } catch (e) {
            return true;
        }
    };

    // --- ICONS (SVG as React Components) ---
    const HomeIcon = (props) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
        <path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.68-8.69a2.25 2.25 0 00-3.18 0l-8.69 8.69a.75.75 0 001.06 1.06l8.69-8.69z" />
        <path d="M12 5.432l8.159 8.159c.026.026.05.055.07.084v6.175c0 .621-.504 1.125-1.125 1.125H4.896A1.125 1.125 0 013.77 19.85v-6.175a.973.973 0 01.07-.084L12 5.432z" />
      </svg>
    );
    const Cog6ToothIcon = (props) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
        <path fillRule="evenodd" d="M11.078 2.25c-.917 0-1.699.663-1.946 1.55l-.26 1.04a5.06 5.06 0 00-2.227 2.227l-1.04.26a1.946 1.946 0 00-1.55 1.946 1.946 1.946 0 001.55 1.946l1.04.26a5.06 5.06 0 002.227 2.227l.26 1.04c.247.887 1.029 1.55 1.946 1.55h1.844c.917 0 1.699-.663 1.946-1.55l.26-1.04a5.06 5.06 0 002.227-2.227l1.04-.26a1.946 1.946 0 001.55-1.946 1.946 1.946 0 00-1.55-1.946l-1.04-.26a5.06 5.06 0 00-2.227-2.227l-.26-1.04A1.946 1.946 0 0012.922 2.25H11.08zm4.493 8.75a3 3 0 10-6 0 3 3 0 006 0z" clipRule="evenodd" />
      </svg>
    );
    const ShoppingBagIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
            <path fillRule="evenodd" d="M7.5 6v.75H5.513c-.96 0-1.763.746-1.858 1.701L2.22 19.83c-.156 1.63.992 3.17 2.65 3.17h14.26c1.658 0 2.806-1.54 2.65-3.17L18.345 8.451a1.875 1.875 0 00-1.858-1.701H16.5V6a4.5 4.5 0 10-9 0zM12 3a3 3 0 00-3 3v.75h6V6a3 3 0 00-3-3z" clipRule="evenodd" />
        </svg>
    );
    const ChartBarIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
          <path d="M3 3v18h18V3H3zm16.5 16.5h-15V4.5h15v15z" /><path d="M12.75 9.6a.75.75 0 00-1.5 0v7.4a.75.75 0 001.5 0V9.6zM8.25 12.68a.75.75 0 00-1.5 0v4.32a.75.75 0 001.5 0v-4.32zM17.25 7.52a.75.75 0 00-1.5 0v9.48a.75.75 0 001.5 0V7.52z" />
        </svg>
    );
    const ArrowPathIcon = (props) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
        <path fillRule="evenodd" d="M15.312 5.25a1.5 1.5 0 011.061.438l4.5 4.5a1.5 1.5 0 010 2.122l-4.5 4.5a1.5 1.5 0 11-2.122-2.121l1.72-1.721H4.5a1.5 1.5 0 010-3h11.432l-1.72-1.721a1.5 1.5 0 011.06-2.561z" clipRule="evenodd" />
      </svg>
    );
    const PlusIcon = (props) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
        <path fillRule="evenodd" d="M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z" clipRule="evenodd" />
      </svg>
    );
    const PencilIcon = (props) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
        <path d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 000-3.712zM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 00-1.32 2.214l-.8 2.685a.75.75 0 00.933.933l2.685-.8a5.25 5.25 0 002.214-1.32l8.4-8.4z" />
        <path d="M5.25 5.25a3 3 0 00-3 3v10.5a3 3 0 003 3h10.5a3 3 0 003-3V13.5a.75.75 0 00-1.5 0v5.25a1.5 1.5 0 01-1.5 1.5H5.25a1.5 1.5 0 01-1.5-1.5V8.25a1.5 1.5 0 011.5-1.5h5.25a.75.75 0 000-1.5H5.25z" />
      </svg>
    );
    const TrashIcon = (props) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
        <path fillRule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 013.878.512.75.75 0 11-.256 1.478l-.209-.035-1.005 13.006a.75.75 0 01-.742.742H5.684a.75.75 0 01-.742-.742L3.94 6.66l-.209.035a.75.75 0 01-.256-1.478A48.567 48.567 0 017.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 013.369 0c1.603.051 2.815 1.387 2.815 2.951zm-6.136-1.452a51.196 51.196 0 013.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 00-6 0v-.113c0-.794.609-1.428 1.364-1.452z" clipRule="evenodd" />
      </svg>
    );
    const XMarkIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}>
            <path fillRule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clipRule="evenodd" />
        </svg>
    );

    // --- CONTEXT & STATE MANAGEMENT ---
    
    const AppContext = createContext();

    const initialState = {
        page: 'store', // store, dashboard, settings, login
        products: [],
        categories: [],
        cart: [],
        settings: {
            storeName: 'Clean Center',
            storeLogo: '',
            whatsappNumber: '+966500000000',
            supabaseUrl: '',
            supabaseAnonKey: '',
            cloudinaryCloudName: '',
            cloudinaryUploadPreset: '',
            openrouterApiKey: '',
            openrouterModel: 'openai/gpt-3.5-turbo',
        },
        auth: {
            user: null,
            session: null,
            loading: true,
        },
        loading: true,
        error: null,
        notifications: [],
        lastBackup: null,
    };

    function appReducer(state, action) {
        switch (action.type) {
            case 'SET_PAGE':
                return { ...state, page: action.payload };
            case 'SET_DATA':
                return { ...state, ...action.payload, loading: false };
            case 'ADD_NOTIFICATION':
                return { ...state, notifications: [...state.notifications, action.payload] };
            case 'REMOVE_NOTIFICATION':
                return { ...state, notifications: state.notifications.filter(n => n.id !== action.payload) };
            case 'SET_SETTINGS':
                return { ...state, settings: { ...state.settings, ...action.payload } };
            case 'SET_AUTH':
                return { ...state, auth: { ...state.auth, ...action.payload } };
            case 'ADD_TO_CART': {
                const existing = state.cart.find(item => item.id === action.payload.id);
                if (existing) {
                    return { ...state, cart: state.cart.map(item => item.id === action.payload.id ? { ...item, quantity: item.quantity + 1 } : item) };
                }
                return { ...state, cart: [...state.cart, { ...action.payload, quantity: 1 }] };
            }
            case 'UPDATE_CART_QUANTITY':
                return { ...state, cart: state.cart.map(item => item.id === action.payload.id ? { ...item, quantity: Math.max(0, action.payload.quantity) } : item).filter(item => item.quantity > 0) };
            case 'CLEAR_CART':
                return { ...state, cart: [] };
            case 'SET_LAST_BACKUP':
                return { ...state, lastBackup: action.payload };
            case 'SET_LOADING':
                return { ...state, loading: action.payload };
            case 'SET_ERROR':
                return { ...state, error: action.payload, loading: false };
            default:
                return state;
        }
    }

    const AppProvider = ({ children }) => {
        const [state, dispatch] = useReducer(appReducer, initialState);
        const [supabase, setSupabase] = useState(null);

        // Load settings from localStorage
        useEffect(() => {
            try {
                const savedSettings = JSON.parse(localStorage.getItem('cleanCenterSettings'));
                if (savedSettings) {
                    dispatch({ type: 'SET_SETTINGS', payload: savedSettings });
                }
                const lastBackup = localStorage.getItem('cleanCenterLastBackup');
                if(lastBackup) {
                    dispatch({ type: 'SET_LAST_BACKUP', payload: new Date(lastBackup).toLocaleString() });
                }
            } catch (e) { console.error("Could not load settings from localStorage", e); }
        }, []);

        // Initialize Supabase client
        useEffect(() => {
            if (state.settings.supabaseUrl && state.settings.supabaseAnonKey) {
                try {
                    const client = window.supabase_js.createClient(state.settings.supabaseUrl, state.settings.supabaseAnonKey);
                    setSupabase(client);
                } catch (e) {
                    console.error("Failed to initialize Supabase client", e);
                    dispatch({ type: 'ADD_NOTIFICATION', payload: { id: Date.now(), type: 'error', message: 'فشل تهيئة Supabase. تحقق من الرابط والمفتاح.' } });
                }
            }
        }, [state.settings.supabaseUrl, state.settings.supabaseAnonKey]);

        // Supabase Auth listener
        useEffect(() => {
            if (!supabase) {
                dispatch({ type: 'SET_AUTH', payload: { loading: false } });
                return;
            };

            const { data: { subscription } } = supabase.auth.onAuthStateChange(
                (event, session) => {
                    dispatch({ type: 'SET_AUTH', payload: { user: session?.user ?? null, session, loading: false } });
                    if (event === 'SIGNED_IN' && !state.auth.user ) {
                        dispatch({ type: 'SET_PAGE', payload: 'dashboard' });
                    }
                    if (event === 'SIGNED_OUT') {
                        dispatch({ type: 'SET_PAGE', payload: 'store' });
                    }
                }
            );

            return () => subscription.unsubscribe();
        }, [supabase]);
        
        // Initial Data Load
        useEffect(() => {
            const loadData = async () => {
                dispatch({ type: 'SET_LOADING', payload: true });
                try {
                    let products, categories;
                    if (supabase) {
                        const { data: catData, error: catError } = await supabase.from('categories').select('*');
                        if (catError) throw catError;
                        categories = catData;
                        await db.putAll('categories', categories);
                        
                        const { data: prodData, error: prodError } = await supabase.from('products').select('*');
                        if (prodError) throw prodError;
                        products = prodData;
                        await db.putAll('products', products);
                        
                    } else {
                        categories = await db.getAll('categories');
                        products = await db.getAll('products');
                    }
                    dispatch({ type: 'SET_DATA', payload: { products, categories } });
                } catch (error) {
                    console.error("Error loading data:", error);
                    dispatch({ type: 'SET_ERROR', payload: `فشل تحميل البيانات: ${error.message}` });
                     try {
                        const categories = await db.getAll('categories');
                        const products = await db.getAll('products');
                        dispatch({ type: 'SET_DATA', payload: { products, categories } });
                        dispatch({ type: 'ADD_NOTIFICATION', payload: { id: Date.now(), type: 'warning', message: 'تم عرض البيانات المحلية. لا يوجد اتصال بالخادم.' } });
                    } catch (dbError) {
                        dispatch({ type: 'SET_ERROR', payload: `فشل تحميل البيانات من الخادم ومن التخزين المحلي: ${dbError.message}` });
                    }
                }
            };
            loadData();
        }, [supabase]);


        const addNotification = useCallback((message, type = 'info', duration = 5000) => {
            const id = Date.now();
            dispatch({ type: 'ADD_NOTIFICATION', payload: { id, message, type } });
            setTimeout(() => dispatch({ type: 'REMOVE_NOTIFICATION', payload: id }), duration);
        }, []);

        const syncWithSupabase = async () => {
            if (!supabase) {
                addNotification("إعدادات Supabase غير مكتملة.", "error");
                return;
            }
            addNotification("بدء المزامنة مع Supabase...");
            try {
                // Fetch latest from Supabase
                const { data: catData, error: catError } = await supabase.from('categories').select('*');
                if (catError) throw catError;
                const { data: prodData, error: prodError } = await supabase.from('products').select('*');
                if (prodError) throw prodError;

                // Update IndexedDB
                await db.putAll('categories', catData);
                await db.putAll('products', prodData);

                // Update state
                dispatch({ type: 'SET_DATA', payload: { products: prodData, categories: catData } });
                addNotification("تمت المزامنة بنجاح!", "success");
            } catch (error) {
                console.error("Sync error:", error);
                addNotification(`فشل المزامنة: ${error.message}`, "error");
            }
        };

        const globalActions = {
            setPage: (page) => dispatch({ type: 'SET_PAGE', payload: page }),
            addNotification,
            saveSettings: (settings) => {
                localStorage.setItem('cleanCenterSettings', JSON.stringify(settings));
                dispatch({ type: 'SET_SETTINGS', payload: settings });
                addNotification('تم حفظ الإعدادات بنجاح.', 'success');
            },
            
            // CRUD actions
            handleCrud: async (operation, entity, data) => {
                dispatch({type: 'SET_LOADING', payload: true});
                const entityPlural = entity === 'category' ? 'categories' : 'products';
                const id = data?.id;

                try {
                    let result;
                    if(supabase){
                        let query = supabase.from(entityPlural);
                        if(operation === 'add') result = await query.insert(data).select().single();
                        if(operation === 'update') result = await query.update(data).eq('id', id).select().single();
                        if(operation === 'delete') result = await query.delete().eq('id', id);
                        
                        if(result.error) throw result.error;
                        
                        // Sync with local after successful Supabase operation
                        await syncWithSupabase();
                    } else {
                        // Offline mode
                        if(operation === 'add') await db.put(entityPlural, {...data, id: data.id || `local_${Date.now()}`});
                        if(operation === 'update') await db.put(entityPlural, data);
                        if(operation === 'delete') await db.delete(entityPlural, id);

                        const allData = await db.getAll(entityPlural);
                        dispatch({ type: 'SET_DATA', payload: { [entityPlural]: allData } });
                    }
                    
                    addNotification(`تم ${operation === 'add' ? 'إضافة' : operation === 'update' ? 'تحديث' : 'حذف'} ${entity} بنجاح.`, 'success');

                } catch (error) {
                    console.error(`${operation} ${entity} failed:`, error);
                    addNotification(`فشل ${operation} ${entity}: ${error.message}`, 'error');
                } finally {
                    dispatch({type: 'SET_LOADING', payload: false});
                }
            },
            
            // Auth actions
            signIn: async (email, password) => {
                if (!supabase) return addNotification('Supabase client not initialized', 'error');
                dispatch({ type: 'SET_AUTH', payload: { loading: true } });
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) {
                    addNotification(error.message, 'error');
                    dispatch({ type: 'SET_AUTH', payload: { loading: false } });
                } else {
                   addNotification('تم تسجيل الدخول بنجاح.', 'success');
                }
            },
            signOut: async () => {
                if (!supabase) return;
                const { error } = await supabase.auth.signOut();
                if (error) addNotification(error.message, 'error');
                else {
                    dispatch({ type: 'SET_PAGE', payload: 'store' });
                    addNotification('تم تسجيل الخروج.', 'info');
                }
            },

            // Cart actions
            addToCart: (product) => dispatch({ type: 'ADD_TO_CART', payload: product }),
            updateCartQuantity: (id, quantity) => dispatch({ type: 'UPDATE_CART_QUANTITY', payload: { id, quantity } }),
            clearCart: () => dispatch({ type: 'CLEAR_CART' }),

            // Data Management
            backupData: async () => {
                try {
                    const products = await db.getAll('products');
                    const categories = await db.getAll('categories');
                    const settings = JSON.parse(localStorage.getItem('cleanCenterSettings') || '{}');
                    
                    const backup = {
                        version: 1,
                        timestamp: new Date().toISOString(),
                        data: { products, categories, settings }
                    };

                    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cleancenter_backup_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    const lastBackupTime = new Date();
                    localStorage.setItem('cleanCenterLastBackup', lastBackupTime.toISOString());
                    dispatch({ type: 'SET_LAST_BACKUP', payload: lastBackupTime.toLocaleString() });
                    addNotification('تم إنشاء نسخة احتياطية بنجاح!', 'success');
                } catch (e) {
                    addNotification('فشل إنشاء النسخة الاحتياطية.', 'error');
                }
            },
            restoreData: async (file) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        const { products, categories, settings } = backup.data;
                        
                        await db.clear('products');
                        await db.clear('categories');
                        
                        await db.putAll('products', products);
                        await db.putAll('categories', categories);
                        
                        localStorage.setItem('cleanCenterSettings', JSON.stringify(settings));
                        
                        dispatch({ type: 'SET_DATA', payload: { products, categories } });
                        dispatch({ type: 'SET_SETTINGS', payload: settings });

                        if (supabase) {
                            addNotification('تم استعادة البيانات محلياً. يُنصح بالمزامنة مع Supabase.', 'warning');
                        } else {
                            addNotification('تم استعادة البيانات بنجاح.', 'success');
                        }

                    } catch (err) {
                        addNotification(`فشل استعادة البيانات: ${err.message}`, 'error');
                    }
                };
                reader.readAsText(file);
            },
            deleteAllData: async () => {
                if (window.confirm("هل أنت متأكد من حذف جميع البيانات؟ لا يمكن التراجع عن هذا الإجراء.")) {
                    try {
                        await db.clear('products');
                        await db.clear('categories');
                        localStorage.removeItem('cleanCenterSettings');
                        localStorage.removeItem('cleanCenterLastBackup');
                        // a full reload is the cleanest way to reset state
                        window.location.reload();
                    } catch(e) {
                        addNotification('فشل حذف البيانات.', 'error');
                    }
                }
            },
        };

        return <AppContext.Provider value={{ state, dispatch, actions: globalActions, supabase }}>{children}</AppContext.Provider>;
    };

    // --- GENERIC UI COMPONENTS ---

    const GlassmorphismCard = ({ children, className = '' }) => (
        <div className={`bg-white/10 backdrop-blur-lg border border-white/20 rounded-xl shadow-glass overflow-hidden ${className}`}>
            {children}
        </div>
    );
    
    const LoadingSpinner = () => (
      <div className="flex justify-center items-center h-full w-full">
        <svg className="animate-spin -ml-1 mr-3 h-10 w-10 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
    );

    const NotificationContainer = () => {
        const { state, dispatch } = useContext(AppContext);
        const { notifications } = state;

        if (!notifications.length) return null;

        const colorClasses = {
            info: 'bg-blue-500',
            success: 'bg-green-500',
            warning: 'bg-yellow-500',
            error: 'bg-red-500',
        };

        return (
            <div className="fixed top-5 left-1/2 -translate-x-1/2 z-50 flex flex-col items-center gap-2 no-print">
            {notifications.map(n => (
                <div key={n.id} className={`${colorClasses[n.type]} text-white py-2 px-4 rounded-lg shadow-lg flex items-center justify-between animate-fade-in-down`}>
                    <p>{n.message}</p>
                    <button onClick={() => dispatch({ type: 'REMOVE_NOTIFICATION', payload: n.id })} className="mr-4 text-xl">&times;</button>
                </div>
            ))}
            </div>
        );
    };

    const Modal = ({ isOpen, onClose, title, children }) => {
        if (!isOpen) return null;

        return (
            <div className="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 no-print" onClick={onClose}>
                <div className="bg-gray-800/80 backdrop-blur-xl border border-white/20 rounded-xl shadow-glass max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center p-4 border-b border-white/10">
                        <h3 className="text-xl font-bold">{title}</h3>
                        <button onClick={onClose} className="text-gray-400 hover:text-white transition">
                            <XMarkIcon className="w-6 h-6" />
                        </button>
                    </div>
                    <div className="p-6">
                        {children}
                    </div>
                </div>
            </div>
        );
    };

    const Input = (props) => (
        <input 
            {...props} 
            className="w-full bg-gray-900/50 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" 
        />
    );
    const TextArea = (props) => (
       <textarea 
            {...props} 
            className="w-full bg-gray-900/50 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" 
       />
    );
     const Select = ({children, ...props}) => (
       <select 
            {...props}
             className="w-full bg-gray-900/50 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition appearance-none"
       >
         {children}
       </select>
     );
    const Button = ({ children, onClick, className = '', type = 'button', disabled=false }) => (
        <button 
            type={type}
            onClick={onClick} 
            disabled={disabled}
            className={`px-4 py-2 rounded-lg font-semibold transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 ${className} ${disabled ? 'bg-gray-500 cursor-not-allowed' : 'hover:opacity-90'}`}
        >
            {children}
        </button>
    );

    // --- APPLICATION COMPONENTS ---
    
    // Header Component
    const Header = () => {
        const { state, actions } = useContext(AppContext);
        const { page, cart, auth } = state;
        const setPage = actions.setPage;
        
        const navItemClasses = "px-3 py-2 rounded-md text-sm font-medium transition cursor-pointer";
        const activeClasses = "bg-cyan-500/20 text-cyan-300";
        const inactiveClasses = "text-gray-300 hover:bg-gray-700 hover:text-white";

        return (
            <header className="fixed top-0 left-0 right-0 z-30 bg-gray-900/50 backdrop-blur-lg border-b border-white/10 no-print">
                <nav className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex items-center justify-between h-16">
                        <div className="flex items-center">
                            <div className="flex-shrink-0 text-white font-bold text-xl flex items-center">
                                {state.settings.storeLogo ? (
                                    <img src={state.settings.storeLogo} alt="Logo" className="h-8 w-8 rounded-full object-cover mr-2" />
                                 ) : <ShoppingBagIcon className="w-7 h-7 mr-2 text-cyan-400"/>
                                 }
                                {state.settings.storeName}
                            </div>
                            <div className="hidden md:block">
                                <div className="mr-10 flex items-baseline space-x-4 space-x-reverse">
                                    <span onClick={() => setPage('store')} className={`${navItemClasses} ${page === 'store' ? activeClasses : inactiveClasses}`}>
                                        المتجر
                                    </span>
                                    {auth.user && (
                                        <>
                                            <span onClick={() => setPage('dashboard')} className={`${navItemClasses} ${page === 'dashboard' ? activeClasses : inactiveClasses}`}>
                                                لوحة التحكم
                                            </span>
                                            <span onClick={() => setPage('settings')} className={`${navItemClasses} ${page === 'settings' ? activeClasses : inactiveClasses}`}>
                                                الإعدادات
                                            </span>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center">
                            <button onClick={() => actions.setPage('cart')} className="relative p-2 rounded-full text-gray-400 hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                                <ShoppingBagIcon className="h-6 w-6"/>
                                {cart.length > 0 && <span className="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs font-bold text-white">{cart.reduce((sum, item) => sum + item.quantity, 0)}</span>}
                            </button>
                            {auth.user ? (
                                <Button onClick={actions.signOut} className="bg-red-600 text-white mr-3">خروج</Button>
                            ) : (
                                <Button onClick={() => setPage('login')} className="bg-cyan-600 text-white mr-3">
                                    <Cog6ToothIcon className="h-5 w-5 inline-block ml-1"/>
                                    دخول المسؤول
                                </Button>
                            )}
                        </div>
                    </div>
                </nav>
            </header>
        );
    };

    // Storefront Page
    const StorefrontPage = () => {
        const { state, actions } = useContext(AppContext);
        const { products, categories, loading, error } = state;
        const [filter, setFilter] = useState({ categoryId: 'all', searchTerm: '' });
        
        const filteredProducts = products
            .filter(p => filter.categoryId === 'all' || p.category_id === filter.categoryId)
            .filter(p => p.name.toLowerCase().includes(filter.searchTerm.toLowerCase()));

        if(loading && products.length === 0) return <div className="mt-20"><LoadingSpinner /></div>;
        if(error) return <div className="mt-20 text-center text-red-400">{error}</div>;

        return (
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <GlassmorphismCard className="p-4 mb-8">
                    <div className="flex flex-col md:flex-row gap-4">
                        <Input
                            type="text"
                            placeholder="ابحث عن منتج..."
                            value={filter.searchTerm}
                            onChange={(e) => setFilter({...filter, searchTerm: e.target.value})}
                            className="flex-grow"
                        />
                         <div className="relative">
                            <Select
                                value={filter.categoryId}
                                onChange={(e) => setFilter({...filter, categoryId: e.target.value})}
                                 className="w-full md:w-64 pr-10"
                            >
                                <option value="all">كل الأقسام</option>
                                {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                            </Select>
                         </div>
                    </div>
                </GlassmorphismCard>
                
                {filteredProducts.length > 0 ? (
                    <div id="print-area" className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        {filteredProducts.map(product => (
                            <GlassmorphismCard key={product.id} className="flex flex-col group">
                                <div className="relative h-48 bg-gray-900/50">
                                   {product.image_url ? 
                                       <img src={product.image_url} alt={product.name} className="h-full w-full object-cover"/> : 
                                       <div className="h-full w-full flex items-center justify-center text-gray-500"><ShoppingBagIcon className="w-16 h-16"/></div>
                                   }
                                </div>
                                <div className="p-4 flex flex-col flex-grow">
                                    <h3 className="text-lg font-bold text-white mb-1">{product.name}</h3>
                                    <p className="text-gray-400 text-sm mb-4 flex-grow">{product.description}</p>
                                    <div className="flex justify-between items-center">
                                       <p className="text-xl font-bold text-cyan-400">{parseFloat(product.price).toFixed(2)} ر.س</p>
                                        <Button onClick={() => actions.addToCart(product)} className="bg-cyan-600 text-white">
                                            إضافة للسلة
                                        </Button>
                                    </div>
                                </div>
                            </GlassmorphismCard>
                        ))}
                    </div>
                ) : (
                    <GlassmorphismCard className="p-10 text-center text-gray-400">
                        <h3 className="text-2xl font-bold mb-2">لا توجد منتجات</h3>
                        <p>لم يتم العثور على منتجات تطابق بحثك.</p>
                    </GlassmorphismCard>
                )}
            </div>
        );
    };

    // Shopping Cart Modal
    const ShoppingCart = () => {
        const { state, actions } = useContext(AppContext);
        const { cart, settings } = state;

        const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

        const generateWhatsAppMessage = () => {
            let message = `*طلب جديد من متجر ${settings.storeName}*\n\n`;
            cart.forEach(item => {
                message += `- ${item.name} (الكمية: ${item.quantity}) - ${item.price} ر.س\n`;
            });
            message += `\n*الإجمالي: ${total.toFixed(2)} ر.س*`;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${settings.whatsappNumber.replace(/\+/g, '')}&text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        };

        return (
            <Modal isOpen={state.page === 'cart'} onClose={() => actions.setPage('store')} title="سلة التسوق">
                {cart.length > 0 ? (
                    <div>
                        <div className="space-y-4 max-h-96 overflow-y-auto pr-2">
                        {cart.map(item => (
                            <div key={item.id} className="flex items-center justify-between">
                                <div className="flex items-center">
                                    <img src={item.image_url} alt={item.name} className="w-16 h-16 rounded-lg object-cover mr-4" />
                                    <div>
                                        <p className="font-bold">{item.name}</p>
                                        <p className="text-sm text-gray-400">{item.price} ر.س</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <input 
                                        type="number" 
                                        value={item.quantity}
                                        onChange={(e) => actions.updateCartQuantity(item.id, parseInt(e.target.value))}
                                        className="w-16 bg-gray-700 text-center rounded"
                                        min="1"
                                    />
                                     <button onClick={() => actions.updateCartQuantity(item.id, 0)} className="text-red-400 hover:text-red-300">
                                         <TrashIcon className="w-5 h-5"/>
                                     </button>
                                </div>
                            </div>
                        ))}
                        </div>
                        <div className="mt-6 pt-4 border-t border-white/10">
                            <div className="flex justify-between items-center text-xl font-bold">
                                <span>الإجمالي:</span>
                                <span>{total.toFixed(2)} ر.س</span>
                            </div>
                            <div className="mt-6 flex flex-col sm:flex-row gap-2">
                                <Button onClick={generateWhatsAppMessage} className="bg-green-600 text-white flex-grow">
                                    إرسال الطلب عبر واتساب
                                </Button>
                                <Button onClick={actions.clearCart} className="bg-red-600 text-white">إفراغ السلة</Button>
                            </div>
                        </div>
                    </div>
                ) : (
                    <p className="text-center text-gray-400 py-8">سلة التسوق فارغة.</p>
                )}
            </Modal>
        );
    };

    // Login Page
    const LoginPage = () => {
        const { actions, state } = useContext(AppContext);
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');

        const handleSubmit = (e) => {
            e.preventDefault();
            actions.signIn(email, password);
        };
        
        return (
            <div className="flex items-center justify-center min-h-screen">
                <GlassmorphismCard className="w-full max-w-md">
                     <form onSubmit={handleSubmit} className="p-8 space-y-6">
                        <h2 className="text-2xl font-bold text-center">دخول لوحة التحكم</h2>
                        
                        <div>
                            <label className="block text-sm font-medium mb-1">البريد الإلكتروني</label>
                            <Input 
                                type="email" 
                                value={email}
                                onChange={e => setEmail(e.target.value)} 
                                placeholder="admin@example.com"
                                required 
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">كلمة المرور</label>
                            <Input 
                                type="password"
                                value={password}
                                onChange={e => setPassword(e.target.value)} 
                                placeholder="********"
                                required 
                            />
                        </div>
                        
                        <Button type="submit" className="w-full bg-cyan-600 text-white" disabled={state.auth.loading}>
                            {state.auth.loading ? 'جارِ الدخول...' : 'دخول'}
                        </Button>
                        <Button onClick={() => actions.setPage('store')} className="w-full bg-gray-600 text-white">
                           العودة للمتجر
                        </Button>
                     </form>
                </GlassmorphismCard>
            </div>
        );
    };
    
    // Dashboard Page
    const DashboardPage = () => {
        const { state } = useContext(AppContext);
        const { products, categories } = state;
        const chartRef = useRef(null);
        const chartInstance = useRef(null);
        
        const totalProducts = products.length;
        const totalCategories = categories.length;
        const totalStockValue = products.reduce((sum, p) => sum + (p.price * p.stock_quantity), 0);

        useEffect(() => {
            if (chartRef.current && categories.length > 0) {
                 if (chartInstance.current) {
                    chartInstance.current.destroy();
                }
                
                const ctx = chartRef.current.getContext('2d');
                
                const data = {
                    labels: categories.map(c => c.name),
                    datasets: [{
                        label: 'عدد المنتجات في كل قسم',
                        data: categories.map(c => products.filter(p => p.category_id === c.id).length),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.5)', 'rgba(239, 68, 68, 0.5)', 
                            'rgba(245, 158, 11, 0.5)', 'rgba(16, 185, 129, 0.5)',
                            'rgba(168, 85, 247, 0.5)', 'rgba(236, 72, 153, 0.5)'
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)', 'rgb(239, 68, 68)',
                            'rgb(245, 158, 11)', 'rgb(16, 185, 129)',
                            'rgb(168, 85, 247)', 'rgb(236, 72, 153)'
                        ],
                        borderWidth: 1
                    }]
                };

                chartInstance.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#fff'
                                }
                            }
                        }
                    }
                });
            }
        }, [products, categories]);
        
        return (
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
                 <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <GlassmorphismCard className="p-5">
                        <h3 className="text-gray-300">إجمالي المنتجات</h3>
                        <p className="text-3xl font-bold text-cyan-400">{totalProducts}</p>
                    </GlassmorphismCard>
                     <GlassmorphismCard className="p-5">
                        <h3 className="text-gray-300">إجمالي الأقسام</h3>
                        <p className="text-3xl font-bold text-cyan-400">{totalCategories}</p>
                    </GlassmorphismCard>
                     <GlassmorphismCard className="p-5">
                        <h3 className="text-gray-300">قيمة المخزون (تقريبي)</h3>
                        <p className="text-3xl font-bold text-cyan-400">{totalStockValue.toFixed(2)} ر.س</p>
                    </GlassmorphismCard>
                </div>
                
                <div className="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div className="lg:col-span-2">
                        <GlassmorphismCard className="p-5 h-80">
                            <h3 className="font-bold mb-4">المنتجات حسب القسم</h3>
                            <div className="relative h-64">
                                <canvas ref={chartRef}></canvas>
                            </div>
                        </GlassmorphismCard>
                    </div>
                     <div className="lg:col-span-3">
                        <CategoryManager />
                    </div>
                </div>
                
                <div>
                  <ProductManager />
                </div>
            </div>
        );
    };

    const CrudManager = ({ title, data, columns, renderRow, onAdd, onEdit, onDelete }) => {
        const [sortConfig, setSortConfig] = useState(null);
        const [filter, setFilter] = useState('');

        const sortedData = React.useMemo(() => {
            let sortableItems = [...data];
            if (sortConfig !== null) {
                sortableItems.sort((a, b) => {
                    if (a[sortConfig.key] < b[sortConfig.key]) {
                        return sortConfig.direction === 'ascending' ? -1 : 1;
                    }
                    if (a[sortConfig.key] > b[sortConfig.key]) {
                        return sortConfig.direction === 'ascending' ? 1 : -1;
                    }
                    return 0;
                });
            }
            return sortableItems;
        }, [data, sortConfig]);

        const filteredData = sortedData.filter(item => 
            Object.values(item).some(val => 
                String(val).toLowerCase().includes(filter.toLowerCase())
            )
        );

        const requestSort = (key) => {
            let direction = 'ascending';
            if (sortConfig && sortConfig.key === key && sortConfig.direction === 'ascending') {
                direction = 'descending';
            }
            setSortConfig({ key, direction });
        };

        const getSortIndicator = (key) => {
            if (!sortConfig || sortConfig.key !== key) return null;
            return sortConfig.direction === 'ascending' ? '▲' : '▼';
        };

        return (
            <GlassmorphismCard>
                <div className="p-4 border-b border-white/10 flex justify-between items-center">
                    <h3 className="text-xl font-bold">{title}</h3>
                    <div className="flex gap-2">
                         <Input type="text" placeholder="فلترة..." value={filter} onChange={e => setFilter(e.target.value)} className="w-48"/>
                         <Button onClick={onAdd} className="bg-cyan-600 text-white flex items-center gap-1">
                             <PlusIcon className="w-5 h-5"/> إضافة
                         </Button>
                    </div>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-right text-gray-300">
                        <thead className="text-xs text-gray-400 uppercase bg-gray-900/50">
                            <tr>
                                {columns.map(col => (
                                    <th key={col.key} scope="col" className="px-6 py-3 cursor-pointer" onClick={() => col.sortable && requestSort(col.key)}>
                                        {col.label} {getSortIndicator(col.key)}
                                    </th>
                                ))}
                                <th scope="col" className="px-6 py-3">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredData.map(item => renderRow(item, onEdit, onDelete))}
                        </tbody>
                    </table>
                     {filteredData.length === 0 && <p className="text-center p-4 text-gray-500">لا توجد بيانات.</p>}
                </div>
            </GlassmorphismCard>
        )
    };
    
    const CategoryManager = () => {
        const { state, actions } = useContext(AppContext);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [currentItem, setCurrentItem] = useState(null);

        const handleAdd = () => {
            setCurrentItem(null);
            setIsModalOpen(true);
        };

        const handleEdit = (item) => {
            setCurrentItem(item);
            setIsModalOpen(true);
        };
        
        const handleDelete = (item) => {
            if(window.confirm(`هل أنت متأكد من حذف قسم "${item.name}"؟`)){
                actions.handleCrud('delete', 'category', item);
            }
        };

        const handleSave = (formData) => {
            const operation = currentItem ? 'update' : 'add';
            const dataToSave = currentItem ? { ...currentItem, ...formData } : { ...formData };
            if(!dataToSave.id && operation === 'add' && state.supabase){
                // Supabase generates UUID, so we don't send one
            } else if (!dataToSave.id && operation === 'add') {
                dataToSave.id = `local_cat_${Date.now()}`;
            }

            actions.handleCrud(operation, 'category', dataToSave);
            setIsModalOpen(false);
        };
        
        return (
            <div>
                 <CrudManager
                    title="إدارة الأقسام"
                    data={state.categories}
                    onAdd={handleAdd}
                    columns={[
                        { key: 'name', label: 'الاسم', sortable: true },
                        { key: 'description', label: 'الوصف', sortable: false },
                    ]}
                    renderRow={(item) => (
                         <tr key={item.id} className="border-b border-gray-700 hover:bg-gray-800/50">
                            <td className="px-6 py-4 font-medium whitespace-nowrap">{item.name}</td>
                            <td className="px-6 py-4 text-gray-400">{item.description?.substring(0, 30)}...</td>
                            <td className="px-6 py-4 flex gap-2">
                                <button onClick={() => handleEdit(item)} className="text-blue-400 hover:text-blue-300"><PencilIcon className="w-5 h-5"/></button>
                                <button onClick={() => handleDelete(item)} className="text-red-400 hover:text-red-300"><TrashIcon className="w-5 h-5"/></button>
                            </td>
                         </tr>
                    )}
                />
                 <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={currentItem ? 'تعديل قسم' : 'إضافة قسم جديد'}>
                     <CategoryForm initialData={currentItem} onSave={handleSave} onCancel={() => setIsModalOpen(false)} />
                 </Modal>
            </div>
        );
    };

    const CategoryForm = ({ initialData, onSave, onCancel }) => {
        const [formData, setFormData] = useState({ name: '', description: '' });

        useEffect(() => {
            if (initialData) setFormData(initialData);
            else setFormData({ name: '', description: '' });
        }, [initialData]);

        const handleChange = (e) => {
            const { name, value } = e.target;
            setFormData(prev => ({ ...prev, [name]: value }));
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            onSave(formData);
        };

        return (
            <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                     <label>اسم القسم</label>
                     <Input name="name" value={formData.name} onChange={handleChange} required />
                </div>
                 <div>
                     <label>الوصف</label>
                     <TextArea name="description" value={formData.description} onChange={handleChange} />
                </div>
                <div className="flex justify-end gap-2 pt-4">
                    <Button type="button" onClick={onCancel} className="bg-gray-600 text-white">إلغاء</Button>
                    <Button type="submit" className="bg-cyan-600 text-white">حفظ</Button>
                </div>
            </form>
        );
    };

     const ProductManager = () => {
        const { state, actions } = useContext(AppContext);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [currentItem, setCurrentItem] = useState(null);

        const handleAdd = () => {
            setCurrentItem(null);
            setIsModalOpen(true);
        };

        const handleEdit = (item) => {
            setCurrentItem(item);
            setIsModalOpen(true);
        };
        
        const handleDelete = (item) => {
            if(window.confirm(`هل أنت متأكد من حذف منتج "${item.name}"؟`)){
                actions.handleCrud('delete', 'product', item);
            }
        };

        const handleSave = async (formData) => {
            const operation = currentItem ? 'update' : 'add';
            let dataToSave = currentItem ? { ...currentItem, ...formData } : { ...formData };
            if(!dataToSave.id && operation === 'add') {
                if(!state.supabase) dataToSave.id = `local_prod_${Date.now()}`;
            }
            
            await actions.handleCrud(operation, 'product', dataToSave);
            setIsModalOpen(false);
        };
        
        const handleExport = () => {
            const worksheet = XLSX.utils.json_to_sheet(state.products);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Products");
            XLSX.writeFile(workbook, "CleanCenter_Products.xlsx");
            actions.addNotification('تم تصدير البيانات إلى Excel.', 'success');
        };

        return (
            <div>
                 <CrudManager
                    title="إدارة المنتجات"
                    data={state.products}
                    onAdd={handleAdd}
                    columns={[
                        { key: 'name', label: 'الاسم', sortable: true },
                        { key: 'category_id', label: 'القسم', sortable: true },
                        { key: 'price', label: 'السعر', sortable: true },
                        { key: 'stock_quantity', label: 'المخزون', sortable: true },
                    ]}
                    renderRow={(item) => {
                        const category = state.categories.find(c => c.id === item.category_id);
                        return (
                         <tr key={item.id} className="border-b border-gray-700 hover:bg-gray-800/50">
                            <td className="px-6 py-4 font-medium whitespace-nowrap flex items-center gap-2">
                                {item.image_url && <img src={item.image_url} className="w-10 h-10 rounded object-cover" />}
                                {item.name}
                            </td>
                            <td className="px-6 py-4">{category?.name || 'غير مصنف'}</td>
                            <td className="px-6 py-4">{item.price}</td>
                            <td className="px-6 py-4">{item.stock_quantity}</td>
                            <td className="px-6 py-4 flex gap-2">
                                <button onClick={() => handleEdit(item)} className="text-blue-400 hover:text-blue-300"><PencilIcon className="w-5 h-5"/></button>
                                <button onClick={() => handleDelete(item)} className="text-red-400 hover:text-red-300"><TrashIcon className="w-5 h-5"/></button>
                            </td>
                         </tr>
                        );
                    }}
                />
                 <div className="mt-4 flex justify-end">
                     <Button onClick={handleExport} className="bg-green-700 text-white">تصدير إلى Excel</Button>
                 </div>
                 <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={currentItem ? 'تعديل منتج' : 'إضافة منتج جديد'}>
                     <ProductForm initialData={currentItem} onSave={handleSave} onCancel={() => setIsModalOpen(false)} />
                 </Modal>
            </div>
        );
    };
    
    const ProductForm = ({ initialData, onSave, onCancel }) => {
        const { state, actions, supabase } = useContext(AppContext);
        const { settings } = state;
        const [formData, setFormData] = useState({ name: '', description: '', price: 0, category_id: null, sku: '', image_url: '', stock_quantity: 0 });
        const [isUploading, setIsUploading] = useState(false);
 
        useEffect(() => {
            if (initialData) setFormData(initialData);
            else setFormData({ name: '', description: '', price: 0, category_id: null, sku: '', image_url: '', stock_quantity: 0 });
        }, [initialData]);

        const handleChange = (e) => {
            const { name, value, type } = e.target;
            setFormData(prev => ({ ...prev, [name]: type === 'number' ? parseFloat(value) : value }));
        };
        
        const handleImageUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const { cloudinaryCloudName, cloudinaryUploadPreset, supabaseUrl } = settings;
            
            setIsUploading(true);

            // Cloudinary Upload
            if (cloudinaryCloudName && cloudinaryUploadPreset) {
                const url = `https://api.cloudinary.com/v1_1/${cloudinaryCloudName}/image/upload`;
                const fd = new FormData();
                fd.append('file', file);
                fd.append('upload_preset', cloudinaryUploadPreset);
                try {
                    const response = await fetch(url, { method: 'POST', body: fd });
                    const data = await response.json();
                    if(data.secure_url) {
                        setFormData(prev => ({ ...prev, image_url: data.secure_url }));
                        actions.addNotification('تم رفع الصورة بنجاح.', 'success');
                    } else throw new Error(data.error.message);
                } catch(err) {
                     actions.addNotification(`فشل رفع الصورة لـ Cloudinary: ${err.message}`, 'error');
                }
            
            // Supabase Storage Upload
            } else if (supabase) {
                 try {
                    const fileName = `${Date.now()}_${file.name}`;
                    const { data, error } = await supabase.storage.from('product_images').upload(fileName, file);
                    if(error) throw error;
                    
                    const { data: { publicUrl } } = supabase.storage.from('product_images').getPublicUrl(fileName);
                    setFormData(prev => ({...prev, image_url: publicUrl}));
                    actions.addNotification('تم رفع الصورة بنجاح.', 'success');
                 } catch (err) {
                    actions.addNotification(`فشل رفع الصورة لـ Supabase: ${err.message}`, 'error');
                 }
            } else {
                 actions.addNotification('يرجى تكوين Cloudinary أو Supabase لرفع الصور.', 'warning');
            }
            setIsUploading(false);
        };


        const handleSubmit = (e) => {
            e.preventDefault();
            onSave(formData);
        };
        
        return (
            <form onSubmit={handleSubmit} className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                         <label>اسم المنتج</label>
                         <Input name="name" value={formData.name} onChange={handleChange} required />
                    </div>
                     <div>
                         <label>القسم</label>
                         <Select name="category_id" value={formData.category_id || ''} onChange={handleChange}>
                             <option value="">-- اختر قسم --</option>
                             {state.categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                         </Select>
                    </div>
                </div>
                 <div>
                     <label>الوصف</label>
                     <TextArea name="description" value={formData.description} onChange={handleChange} rows="3" />
                </div>
                 <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div>
                         <label>السعر (ر.س)</label>
                         <Input type="number" step="0.01" name="price" value={formData.price} onChange={handleChange} required />
                    </div>
                     <div>
                         <label>الكمية في المخزون</label>
                         <Input type="number" name="stock_quantity" value={formData.stock_quantity} onChange={handleChange} required />
                    </div>
                     <div>
                         <label>SKU (رمز المنتج)</label>
                         <Input name="sku" value={formData.sku} onChange={handleChange} />
                    </div>
                 </div>
                 <div>
                     <label>صورة المنتج</label>
                     <div className="flex items-center gap-4">
                        <Input type="file" onChange={handleImageUpload} className="flex-grow" accept="image/*" />
                        {isUploading && <LoadingSpinner />}
                        {formData.image_url && <img src={formData.image_url} alt="preview" className="w-16 h-16 rounded object-cover" />}
                     </div>
                 </div>
                <div className="flex justify-end gap-2 pt-4">
                    <Button type="button" onClick={onCancel} className="bg-gray-600 text-white">إلغاء</Button>
                    <Button type="submit" className="bg-cyan-600 text-white" disabled={isUploading}>
                        {isUploading ? 'جار رفع الصورة...' : 'حفظ'}
                    </Button>
                </div>
            </form>
        );
    };

    // Settings Page
    const SettingsPage = () => {
        const { state, actions, supabase } = useContext(AppContext);
        const [settings, setSettings] = useState(state.settings);
        const restoreInputRef = useRef(null);

        useEffect(() => {
            setSettings(state.settings);
        }, [state.settings]);

        const handleChange = (e) => {
            const { name, value } = e.target;
            setSettings(prev => ({...prev, [name]: value}));
        };

        const handleSave = () => {
            actions.saveSettings(settings);
        };
        
        const handleLogoUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

             const reader = new FileReader();
             reader.onload = (event) => {
                setSettings(prev => ({...prev, storeLogo: event.target.result}));
             };
             reader.readAsDataURL(file);
        };
        
        const testConnection = async (service) => {
            actions.addNotification(`جاري اختبار اتصال ${service}...`, 'info');
             try {
                if (service === 'Supabase') {
                    const testSupabase = window.supabase_js.createClient(settings.supabaseUrl, settings.supabaseAnonKey);
                    const { data, error } = await testSupabase.from('products').select('*', { head: true, count: 'exact' });
                    if(error) throw error;
                    actions.addNotification('اتصال Supabase ناجح!', 'success');
                } else if (service === 'Cloudinary') {
                    const response = await fetch(`https://api.cloudinary.com/v1_1/${settings.cloudinaryCloudName}/ping`);
                    if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if(data.status !== 'ok') throw new Error('Invalid response from Cloudinary.');
                     actions.addNotification('اتصال Cloudinary ناجح!', 'success');
                } else if (service === 'OpenRouter') {
                    const response = await fetch('https://openrouter.ai/api/v1/auth/key', {
                        headers: { 'Authorization': `Bearer ${settings.openrouterApiKey}` }
                    });
                    if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    actions.addNotification('مفتاح OpenRouter صالح!', 'success');
                }
             } catch(err) {
                 actions.addNotification(`فشل اتصال ${service}: ${err.message}`, 'error');
             }
        };

        return (
            <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
                
                <GlassmorphismCard>
                    <div className="p-4 border-b border-white/10"><h3 className="text-xl font-bold">إعدادات المتجر</h3></div>
                    <div className="p-6 space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label>اسم المتجر</label>
                                <Input name="storeName" value={settings.storeName} onChange={handleChange} />
                            </div>
                            <div>
                                <label>رقم واتساب (مع رمز الدولة)</label>
                                <Input name="whatsappNumber" value={settings.whatsappNumber} onChange={handleChange} placeholder="+966501234567" />
                            </div>
                        </div>
                         <div>
                            <label>شعار المتجر</label>
                            <div className="flex items-center gap-4">
                                <Input type="file" onChange={handleLogoUpload} accept="image/*" />
                                {settings.storeLogo && <img src={settings.storeLogo} alt="logo" className="w-16 h-16 rounded-full object-cover" />}
                            </div>
                         </div>
                    </div>
                </GlassmorphismCard>
                
                <GlassmorphismCard>
                    <div className="p-4 border-b border-white/10"><h3 className="text-xl font-bold">إعدادات الاتصال</h3></div>
                    <div className="p-6 space-y-4">
                        {/* Supabase */}
                        <div className="p-4 border border-gray-600 rounded-lg">
                            <h4 className="font-semibold mb-2">Supabase</h4>
                            <div className="space-y-2">
                                <Input name="supabaseUrl" value={settings.supabaseUrl} onChange={handleChange} placeholder="رابط مشروع Supabase" />
                                <Input name="supabaseAnonKey" value={settings.supabaseAnonKey} onChange={handleChange} placeholder="مفتاح Supabase Anon" />
                                <Button onClick={() => testConnection('Supabase')} className="bg-blue-600 text-white">اختبار الاتصال</Button>
                            </div>
                        </div>

                        {/* Cloudinary */}
                         <div className="p-4 border border-gray-600 rounded-lg">
                            <h4 className="font-semibold mb-2">Cloudinary (لرفع الصور)</h4>
                            <div className="space-y-2">
                                <Input name="cloudinaryCloudName" value={settings.cloudinaryCloudName} onChange={handleChange} placeholder="Cloudinary Cloud Name" />
                                <Input name="cloudinaryUploadPreset" value={settings.cloudinaryUploadPreset} onChange={handleChange} placeholder="Cloudinary Upload Preset (unsigned)" />
                                <Button onClick={() => testConnection('Cloudinary')} className="bg-blue-600 text-white">اختبار الاتصال</Button>
                            </div>
                        </div>

                        {/* OpenRouter */}
                         <div className="p-4 border border-gray-600 rounded-lg">
                            <h4 className="font-semibold mb-2">OpenRouter.ai (للذكاء الاصطناعي)</h4>
                            <div className="space-y-2">
                                <Input name="openrouterApiKey" value={settings.openrouterApiKey} type="password" onChange={handleChange} placeholder="OpenRouter API Key" />
                                <Input name="openrouterModel" value={settings.openrouterModel} onChange={handleChange} placeholder="اسم المودل (e.g., openai/gpt-3.5-turbo)" />
                                <Button onClick={() => testConnection('OpenRouter')} className="bg-blue-600 text-white">اختبار الاتصال</Button>
                            </div>
                        </div>

                    </div>
                </GlassmorphismCard>
                 <GlassmorphismCard>
                    <div className="p-4 border-b border-white/10"><h3 className="text-xl font-bold">إدارة البيانات</h3></div>
                    <div className="p-6 space-y-4">
                         <div className="flex flex-wrap gap-2">
                            <Button onClick={actions.backupData} className="bg-green-600 text-white">تصدير نسخة احتياطية (JSON)</Button>
                            <Button onClick={() => restoreInputRef.current.click()} className="bg-yellow-600 text-white">استيراد نسخة احتياطية (JSON)</Button>
                            <input type="file" ref={restoreInputRef} onChange={e => {actions.restoreData(e.target.files[0]); e.target.value = null;}} className="hidden" accept=".json" />
                            <Button onClick={supabase ? actions.syncWithSupabase : null} disabled={!supabase} className="bg-blue-600 text-white">مزامنة مع Supabase</Button>
                         </div>
                          <div className="flex flex-wrap gap-2">
                            <Button onClick={() => window.print()} className="bg-gray-600 text-white">طباعة المنتجات (A4)</Button>
                            <Button onClick={actions.deleteAllData} className="bg-red-700 text-white">حذف جميع البيانات</Button>
                        </div>
                        {state.lastBackup && <p className="text-sm text-gray-400">آخر نسخة احتياطية: {state.lastBackup}</p>}
                    </div>
                </GlassmorphismCard>

                 <div className="flex justify-end pt-4">
                    <Button onClick={handleSave} className="bg-cyan-600 text-white text-lg px-8">حفظ كل الإعدادات</Button>
                </div>
            </div>
        );
    };
    
    // Main App Component
    const App = () => {
        const { state, actions } = useContext(AppContext);
        const [showIncognitoWarning, setShowIncognitoWarning] = useState(false);
        const { page, auth } = state;
        
        useEffect(() => {
            isIncognito().then(incog => setShowIncognitoWarning(incog));
        }, []);
        
        const renderPage = () => {
            if (auth.loading) {
                return <div className="mt-20"><LoadingSpinner /></div>;
            }
            if (!auth.user && (page === 'dashboard' || page === 'settings')) {
                return <LoginPage />;
            }
            switch (page) {
                case 'dashboard': return <DashboardPage />;
                case 'settings': return <SettingsPage />;
                case 'login': return <LoginPage />;
                case 'store':
                default:
                    return <StorefrontPage />;
            }
        };

        return (
            <div className="min-h-screen">
                <NotificationContainer />
                <Header />
                {showIncognitoWarning && (
                     <div className="no-print bg-yellow-500/20 text-yellow-300 text-center p-2 text-sm mt-16">
                        ⚠️ أنت في وضع التصفح المتخفي. التخزين المحلي مؤقت. نوصي بإنشاء نسخ احتياطية منتظمة.
                    </div>
                )}
                <main className={`transition-all duration-300 pt-16 ${showIncognitoWarning ? '' : 'pt-16'}`}>
                    {renderPage()}
                </main>
                <ShoppingCart />
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
        <AppProvider>
            <App />
        </AppProvider>
    );

    </script>
</body>
</html>

<!-- 
=====================================================================
==== SQL Schema for Supabase ====
=====================================================================
-- انسخ هذا الكود وألصقه في محرر SQL في لوحة تحكم Supabase الخاصة بك

-- 1. Create a table for store categories
CREATE TABLE categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  user_id UUID DEFAULT auth.uid() REFERENCES auth.users(id) ON DELETE CASCADE
);

-- 2. Create a table for products
CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
  name TEXT NOT NULL,
  description TEXT,
  price NUMERIC(10, 2) NOT NULL DEFAULT 0.00,
  sku TEXT,
  image_url TEXT,
  stock_quantity INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  user_id UUID DEFAULT auth.uid() REFERENCES auth.users(id) ON DELETE CASCADE
);
-- Create a unique constraint for SKU per user
ALTER TABLE products ADD CONSTRAINT products_user_id_sku_key UNIQUE (user_id, sku);


-- 3. Enable Row Level Security (RLS) on all tables
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;

-- 4. Create RLS policies
-- CATEGORIES POLICIES
-- Allow public read access to all categories
CREATE POLICY "Public read access for all on categories" ON categories FOR SELECT USING (true);
-- Allow authenticated users (admins) to do everything on their own categories
CREATE POLICY "Allow full access for authenticated users on own categories" ON categories FOR ALL
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- PRODUCTS POLICIES
-- Allow public read access to all products
CREATE POLICY "Public read access for all on products" ON products FOR SELECT USING (true);
-- Allow authenticated users (admins) to do everything on their own products
CREATE POLICY "Allow full access for authenticated users on own products" ON products FOR ALL
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- 5. Setup Storage bucket for product images
-- This needs to be done in the Supabase Dashboard UI > Storage > New bucket
-- Bucket name: product_images
-- Check "Public bucket"

-- After creating the bucket, run these SQL policies:

-- Allow public read access to images
CREATE POLICY "Public read access for images" ON storage.objects
FOR SELECT USING (bucket_id = 'product_images');

-- Allow authenticated users to upload images
CREATE POLICY "Allow authenticated uploads" ON storage.objects
FOR INSERT WITH CHECK (bucket_id = 'product_images' AND auth.role() = 'authenticated');

-- Allow authenticated users to update/delete their own images
CREATE POLICY "Allow authenticated updates/deletes on own images" ON storage.objects
FOR UPDATE|DELETE USING (bucket_id = 'product_images' AND auth.uid() = owner);

-- 6. Add your admin user
-- You can do this from Supabase Dashboard > Authentication > Add user
-- Or run this in a secure environment (NEVER in client code):
-- INSERT INTO auth.users (instance_id, id, aud, role, email, encrypted_password, email_confirmed_at, recovery_token, recovery_sent_at, last_sign_in_at, raw_app_meta_data, raw_user_meta_data, created_at, updated_at, confirmation_token, email_change, email_change_sent_at, confirmed_at)
-- values
-- (
--   '00000000-0000-0000-0000-000000000000',
--   'your-uuid-here-or-gen_random_uuid()', -- replace this
--   'authenticated',
--   'authenticated',
--   'admin@example.com',
--   crypt('your-strong-password', gen_salt('bf')),
--   '2023-01-01 00:00:00.000000+00',
--   '',
--   null,
--   null,
--   '{"provider":"email","providers":["email"]}',
--   '{}',
--   '2023-01-01 00:00:00.000000+00',
--   '2023-01-01 00:00:00.000000+00',
--   '',
--   '',
--   null,
--   '2023-01-01 00:00:00.000000+00'
-- );
-- NOTE: The simplest way is to create the user via the Dashboard UI.

=====================================================================
==== End of SQL Schema ====
=====================================================================
-->
